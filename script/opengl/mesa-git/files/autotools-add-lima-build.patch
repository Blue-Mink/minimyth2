From c6c7eb7f42f75949903dc56ad2d88445522f47fd Mon Sep 17 00:00:00 2001
From: Qiang Yu <yuq825@gmail.com>
Date: Wed, 27 Mar 2019 16:53:52 +0800
Subject: [PATCH] autotools: add lima build

Signed-off-by: Qiang Yu <yuq825@gmail.com>
---
 Makefile.am                                  |  1 +
 configure.ac                                 | 13 +++--
 src/gallium/Makefile.am                      |  5 ++
 src/gallium/drivers/kmsro/Automake.inc       |  4 ++
 src/gallium/drivers/lima/Automake.inc        |  9 ++++
 src/gallium/drivers/lima/Makefile.am         | 34 ++++++++++++
 src/gallium/drivers/lima/Makefile.sources    | 56 ++++++++++++++++++++
 src/gallium/targets/dri/Makefile.am          |  2 +
 src/gallium/winsys/lima/drm/Makefile.am      | 31 +++++++++++
 src/gallium/winsys/lima/drm/Makefile.sources |  3 ++
 10 files changed, 155 insertions(+), 3 deletions(-)
 create mode 100644 src/gallium/drivers/lima/Automake.inc
 create mode 100644 src/gallium/drivers/lima/Makefile.am
 create mode 100644 src/gallium/drivers/lima/Makefile.sources
 create mode 100644 src/gallium/winsys/lima/drm/Makefile.am
 create mode 100644 src/gallium/winsys/lima/drm/Makefile.sources

diff --git a/Makefile.am b/Makefile.am
index 6d3c8cc19b4..aad07449de3 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -77,6 +77,7 @@ noinst_HEADERS = \
 	include/drm-uapi/drm_fourcc.h \
 	include/drm-uapi/drm_mode.h \
 	include/drm-uapi/i915_drm.h \
+	include/drm-uapi/lima_drm.h \
 	include/drm-uapi/tegra_drm.h \
 	include/drm-uapi/v3d_drm.h \
 	include/drm-uapi/vc4_drm.h \
diff --git a/configure.ac b/configure.ac
index 78d5967a437..4369b383d4e 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1409,7 +1409,7 @@ GALLIUM_DRIVERS_DEFAULT="r300,r600,svga,swrast"
 AC_ARG_WITH([gallium-drivers],
     [AS_HELP_STRING([--with-gallium-drivers@<:@=DIRS...@:>@],
         [comma delimited Gallium drivers list, e.g.
-        "i915,nouveau,r300,r600,radeonsi,freedreno,kmsro,svga,swrast,swr,tegra,v3d,vc4,virgl,etnaviv"
+        "i915,nouveau,r300,r600,radeonsi,freedreno,kmsro,svga,swrast,swr,tegra,v3d,vc4,virgl,etnaviv,lima"
         @<:@default=r300,r600,svga,swrast@:>@])],
     [with_gallium_drivers="$withval"],
     [with_gallium_drivers="$GALLIUM_DRIVERS_DEFAULT"])
@@ -2868,6 +2868,10 @@ if test -n "$with_gallium_drivers"; then
                 require_basic_egl "virgl"
             fi
             ;;
+        xlima)
+            HAVE_GALLIUM_LIMA=yes
+            require_libdrm "lima"
+            ;;
         *)
             AC_MSG_ERROR([Unknown Gallium driver: $driver])
             ;;
@@ -2892,8 +2896,8 @@ AM_CONDITIONAL(HAVE_SWR_BUILTIN, test "x$HAVE_SWR_BUILTIN" = xyes)
 
 dnl We need to validate some needed dependencies for renderonly drivers.
 
-if test "x$HAVE_GALLIUM_VC4" != xyes -a "x$HAVE_GALLIUM_KMSRO" = xyes  ; then
-    AC_MSG_ERROR([Building with kmsro requires vc4])
+if test "x$HAVE_GALLIUM_VC4" != xyes -a "x$HAVE_GALLIUM_LIMA" != xyes -a "x$HAVE_GALLIUM_KMSRO" = xyes  ; then
+    AC_MSG_ERROR([Building with kmsro requires vc4 or lima])
 fi
 
 if test "x$HAVE_GALLIUM_NOUVEAU" != xyes -a "x$HAVE_GALLIUM_TEGRA" = xyes; then
@@ -3007,6 +3011,7 @@ AM_CONDITIONAL(HAVE_GALLIUM_SWRAST, test "x$HAVE_GALLIUM_SOFTPIPE" = xyes -o \
 AM_CONDITIONAL(HAVE_GALLIUM_V3D, test "x$HAVE_GALLIUM_V3D" = xyes)
 AM_CONDITIONAL(HAVE_GALLIUM_VC4, test "x$HAVE_GALLIUM_VC4" = xyes)
 AM_CONDITIONAL(HAVE_GALLIUM_VIRGL, test "x$HAVE_GALLIUM_VIRGL" = xyes)
+AM_CONDITIONAL(HAVE_GALLIUM_LIMA, test "x$HAVE_GALLIUM_LIMA" = xyes)
 
 AM_CONDITIONAL(HAVE_GALLIUM_STATIC_TARGETS, test "x$enable_shared_pipe_drivers" = xno)
 
@@ -3151,6 +3156,7 @@ AC_CONFIG_FILES([Makefile
                  src/gallium/drivers/v3d/Makefile
                  src/gallium/drivers/vc4/Makefile
                  src/gallium/drivers/virgl/Makefile
+                 src/gallium/drivers/lima/Makefile
                  src/gallium/state_trackers/clover/Makefile
                  src/gallium/state_trackers/dri/Makefile
                  src/gallium/state_trackers/glx/xlib/Makefile
@@ -3199,6 +3205,7 @@ AC_CONFIG_FILES([Makefile
                  src/gallium/winsys/vc4/drm/Makefile
                  src/gallium/winsys/virgl/drm/Makefile
                  src/gallium/winsys/virgl/vtest/Makefile
+                 src/gallium/winsys/lima/drm/Makefile
                  src/gbm/Makefile
                  src/gbm/main/gbm.pc
                  src/glx/Makefile
diff --git a/src/gallium/Makefile.am b/src/gallium/Makefile.am
index ff69796180f..296cb55a691 100644
--- a/src/gallium/Makefile.am
+++ b/src/gallium/Makefile.am
@@ -94,6 +94,11 @@ if HAVE_GALLIUM_VIRGL
 SUBDIRS += drivers/virgl winsys/virgl/drm winsys/virgl/vtest
 endif
 
+## lima
+if HAVE_GALLIUM_LIMA
+SUBDIRS += drivers/lima winsys/lima/drm
+endif
+
 ## the sw winsys'
 SUBDIRS += winsys/sw/null
 
diff --git a/src/gallium/drivers/kmsro/Automake.inc b/src/gallium/drivers/kmsro/Automake.inc
index 61989f425ac..9422431aca7 100644
--- a/src/gallium/drivers/kmsro/Automake.inc
+++ b/src/gallium/drivers/kmsro/Automake.inc
@@ -1,13 +1,17 @@
 if HAVE_GALLIUM_KMSRO
 
+TARGET_DRIVERS += exynos
 TARGET_DRIVERS += hx8357d
 TARGET_DRIVERS += ili9225
 TARGET_DRIVERS += ili9341
+TARGET_DRIVERS += meson
 TARGET_DRIVERS += mi0283qt
 TARGET_DRIVERS += pl111
 TARGET_DRIVERS += repaper
+TARGET_DRIVERS += rockchip
 TARGET_DRIVERS += st7586
 TARGET_DRIVERS += st7735r
+TARGET_DRIVERS += sun4i-drm
 TARGET_CPPFLAGS += -DGALLIUM_KMSRO
 TARGET_LIB_DEPS += \
     $(top_builddir)/src/gallium/winsys/kmsro/drm/libkmsrodrm.la \
diff --git a/src/gallium/drivers/lima/Automake.inc b/src/gallium/drivers/lima/Automake.inc
new file mode 100644
index 00000000000..057fca22e3a
--- /dev/null
+++ b/src/gallium/drivers/lima/Automake.inc
@@ -0,0 +1,9 @@
+if HAVE_GALLIUM_LIMA
+
+TARGET_DRIVERS += lima
+TARGET_CPPFLAGS += -DGALLIUM_LIMA
+TARGET_LIB_DEPS += \
+	$(top_builddir)/src/gallium/winsys/lima/drm/liblimadrm.la \
+	$(top_builddir)/src/gallium/drivers/lima/liblima.la
+
+endif
diff --git a/src/gallium/drivers/lima/Makefile.am b/src/gallium/drivers/lima/Makefile.am
new file mode 100644
index 00000000000..e9bd151f683
--- /dev/null
+++ b/src/gallium/drivers/lima/Makefile.am
@@ -0,0 +1,34 @@
+# Copyright © 2017 Lima Project
+#
+# Permission is hereby granted, free of charge, to any person obtaining a
+# copy of this software and associated documentation files (the "Software"),
+# to deal in the Software without restriction, including without limitation
+# the rights to use, copy, modify, merge, publish, distribute, sublicense,
+# and/or sell copies of the Software, and to permit persons to whom the
+# Software is furnished to do so, subject to the following conditions:
+#
+# The above copyright notice and this permission notice (including the next
+# paragraph) shall be included in all copies or substantial portions of the
+# Software.
+#
+# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
+# IN THE SOFTWARE.
+
+include Makefile.sources
+include $(top_srcdir)/src/gallium/Automake.inc
+
+AM_CFLAGS = \
+	-I$(top_srcdir)/include/drm-uapi \
+	-I$(top_builddir)/src/compiler/nir \
+	-I$(top_srcdir)/src/compiler/nir \
+	$(GALLIUM_DRIVER_CFLAGS) \
+	$(LIBDRM_CFLAGS)
+
+noinst_LTLIBRARIES = liblima.la
+
+liblima_la_SOURCES = $(C_SOURCES)
diff --git a/src/gallium/drivers/lima/Makefile.sources b/src/gallium/drivers/lima/Makefile.sources
new file mode 100644
index 00000000000..8a7bc7700d2
--- /dev/null
+++ b/src/gallium/drivers/lima/Makefile.sources
@@ -0,0 +1,56 @@
+gpir_SOURCES := \
+	  ir/gp/gpir.h \
+	  ir/gp/nir.c \
+	  ir/gp/node.c \
+	  ir/gp/lower.c \
+	  ir/gp/scheduler.c \
+	  ir/gp/instr.c \
+	  ir/gp/codegen.h \
+	  ir/gp/codegen.c \
+	  ir/gp/reduce_scheduler.c \
+	  ir/gp/value_regalloc.c \
+	  ir/gp/physical_regalloc.c \
+	  ir/gp/disasm.c
+
+ppir_SOURCES := \
+	  ir/pp/ppir.h \
+	  ir/pp/nir.c \
+	  ir/pp/node.c \
+	  ir/pp/lower.c \
+	  ir/pp/scheduler.c \
+	  ir/pp/instr.c \
+	  ir/pp/regalloc.c \
+	  ir/pp/codegen.h \
+	  ir/pp/codegen.c \
+	  ir/pp/node_to_instr.c \
+	  ir/pp/disasm.c
+
+ir_SOURCES := \
+	  ir/lima_ir.h \
+	  $(gpir_SOURCES) \
+	  $(ppir_SOURCES)
+
+C_SOURCES := \
+	  lima_screen.c \
+	  lima_screen.h \
+	  lima_context.c \
+	  lima_context.h \
+	  lima_resource.c \
+	  lima_resource.h \
+	  lima_state.c \
+	  lima_draw.c \
+	  lima_program.c \
+	  lima_query.c \
+	  lima_bo.c \
+	  lima_bo.h \
+	  lima_submit.c \
+	  lima_submit.h \
+	  lima_util.c \
+	  lima_util.h \
+	  lima_texture.c \
+	  lima_texture.h \
+	  lima_fence.c \
+	  lima_fence.h \
+	  lima_tiling.c \
+	  lima_tiling.h \
+	  $(ir_SOURCES)
diff --git a/src/gallium/targets/dri/Makefile.am b/src/gallium/targets/dri/Makefile.am
index f53be532bb2..586caab8f1b 100644
--- a/src/gallium/targets/dri/Makefile.am
+++ b/src/gallium/targets/dri/Makefile.am
@@ -84,6 +84,8 @@ include $(top_srcdir)/src/gallium/drivers/virgl/Automake.inc
 
 include $(top_srcdir)/src/gallium/drivers/etnaviv/Automake.inc
 
+include $(top_srcdir)/src/gallium/drivers/lima/Automake.inc
+
 include $(top_srcdir)/src/gallium/drivers/softpipe/Automake.inc
 include $(top_srcdir)/src/gallium/drivers/llvmpipe/Automake.inc
 include $(top_srcdir)/src/gallium/drivers/swr/Automake.inc
diff --git a/src/gallium/winsys/lima/drm/Makefile.am b/src/gallium/winsys/lima/drm/Makefile.am
new file mode 100644
index 00000000000..4f004171e09
--- /dev/null
+++ b/src/gallium/winsys/lima/drm/Makefile.am
@@ -0,0 +1,31 @@
+# Copyright © 2017 Lima Project
+#
+# Permission is hereby granted, free of charge, to any person obtaining a
+# copy of this software and associated documentation files (the "Software"),
+# to deal in the Software without restriction, including without limitation
+# the rights to use, copy, modify, merge, publish, distribute, sublicense,
+# and/or sell copies of the Software, and to permit persons to whom the
+# Software is furnished to do so, subject to the following conditions:
+#
+# The above copyright notice and this permission notice (including the next
+# paragraph) shall be included in all copies or substantial portions of the
+# Software.
+#
+# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
+# IN THE SOFTWARE.
+
+include Makefile.sources
+include $(top_srcdir)/src/gallium/Automake.inc
+
+AM_CFLAGS = \
+	-I$(top_srcdir)/src/gallium/drivers \
+	$(GALLIUM_WINSYS_CFLAGS)
+
+noinst_LTLIBRARIES = liblimadrm.la
+
+liblimadrm_la_SOURCES = $(C_SOURCES)
diff --git a/src/gallium/winsys/lima/drm/Makefile.sources b/src/gallium/winsys/lima/drm/Makefile.sources
new file mode 100644
index 00000000000..3e67fc682fe
--- /dev/null
+++ b/src/gallium/winsys/lima/drm/Makefile.sources
@@ -0,0 +1,3 @@
+C_SOURCES := \
+	lima_drm_public.h \
+	lima_drm_winsys.c
-- 
2.17.1

