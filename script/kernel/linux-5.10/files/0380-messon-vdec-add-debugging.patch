From 89382b4945a646fc7a7c3b944e2f4f81d49ac2ec Mon Sep 17 00:00:00 2001
From: John Cox <jc@kynesim.co.uk>
Date: Sun, 20 Dec 2020 10:29:20 +0000
Subject: [PATCH] Add debug to decoder_cmd

---
 drivers/staging/media/meson/vdec/vdec.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/drivers/staging/media/meson/vdec/vdec.c b/drivers/staging/media/meson/vdec/vdec.c
index 5d4db7a5b4b5e..5d50045de4804 100644
--- a/drivers/staging/media/meson/vdec/vdec.c
+++ b/drivers/staging/media/meson/vdec/vdec.c
@@ -720,16 +720,24 @@ vdec_decoder_cmd(struct file *file, void *fh, struct v4l2_decoder_cmd *cmd)
 	struct device *dev = sess->core->dev;
 	int ret;
 
+	dev_err(dev, "%s: stream out=%d, stream cap=%d, cmd=%d\n", sess->streamon_out, sess->streamon_cap, cmd->cmd);
+
 	ret = v4l2_m2m_ioctl_try_decoder_cmd(file, fh, cmd);
 	if (ret)
 		return ret;
 
-	if (!(sess->streamon_out & sess->streamon_cap))
+	if (!(sess->streamon_out && sess->streamon_cap))
 		return 0;
 
 	if (cmd->cmd == V4L2_DEC_CMD_START) {
+		struct vb2_queue *dst_vq;
+		dst_vq = v4l2_m2m_get_vq(sess->fh.m2m_ctx, V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE);
+
 		v4l2_m2m_clear_state(sess->m2m_ctx);
+		vb2_clear_last_buffer_dequeued(dst_vq);
 		sess->should_stop = 0;
+
+		dev_err(dev, "Start seen!\n");
 		return 0;
 	}
 
From 8352c0b20a8bb81696fc5ec0f05a3ed3f89b9eb0 Mon Sep 17 00:00:00 2001
From: John Cox <jc@kynesim.co.uk>
Date: Sun, 20 Dec 2020 12:50:47 +0000
Subject: [PATCH] More debug

---
 drivers/staging/media/meson/vdec/vdec.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/drivers/staging/media/meson/vdec/vdec.c b/drivers/staging/media/meson/vdec/vdec.c
index 5d50045de4804..63cd3f14ab206 100644
--- a/drivers/staging/media/meson/vdec/vdec.c
+++ b/drivers/staging/media/meson/vdec/vdec.c
@@ -285,6 +285,9 @@ static int vdec_start_streaming(struct vb2_queue *q, unsigned int count)
 	struct vb2_v4l2_buffer *buf;
 	int ret;
 
+	dev_err(sess->core->dev, "%s: q->type=%d, status=%d, out=%d, cap=%d\n", __func__,
+		q->type, sess->status, sess->streamon_out, sess->streamon_cap);
+
 	if (core->cur_sess && core->cur_sess != sess) {
 		ret = -EBUSY;
 		goto bufs_done;
@@ -399,6 +402,8 @@ static void vdec_stop_streaming(struct vb2_queue *q)
 	struct amvdec_core *core = sess->core;
 	struct vb2_v4l2_buffer *buf;
 
+	dev_err(sess->core->dev, "%s: q->type=%d\n", __func__, q->type);
+
 	if (sess->status == STATUS_RUNNING ||
 	    sess->status == STATUS_INIT ||
 	    (sess->status == STATUS_NEEDS_RESUME &&
@@ -720,7 +725,7 @@ vdec_decoder_cmd(struct file *file, void *fh, struct v4l2_decoder_cmd *cmd)
 	struct device *dev = sess->core->dev;
 	int ret;
 
-	dev_err(dev, "%s: stream out=%d, stream cap=%d, cmd=%d\n", sess->streamon_out, sess->streamon_cap, cmd->cmd);
+	dev_err(dev, "%s: stream out=%d, stream cap=%d, cmd=%d\n", __func__, sess->streamon_out, sess->streamon_cap, cmd->cmd);
 
 	ret = v4l2_m2m_ioctl_try_decoder_cmd(file, fh, cmd);
 	if (ret)
