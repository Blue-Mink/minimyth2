From acd32bb42f44821fc52c81de9721c96ab1e5e3cd Mon Sep 17 00:00:00 2001
From: Ondrej Jirman <megous@megous.com>
Date: Sun, 1 Sep 2019 23:43:09 +0200
Subject: [PATCH 13/26] thermal: sun8i: Thermal sensor on H6 needs
 undocummented value in CTRL0

Otherwise temperature will be off by 20 degrees.

Signed-off-by: Ondrej Jirman <megous@megous.com>
---
 drivers/thermal/sun8i_thermal.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/drivers/thermal/sun8i_thermal.c b/drivers/thermal/sun8i_thermal.c
index 263c25e6fe90..c9b1b33f210b 100644
--- a/drivers/thermal/sun8i_thermal.c
+++ b/drivers/thermal/sun8i_thermal.c
@@ -420,6 +420,12 @@ static int sun8i_h3_thermal_init(struct ths_device *tmdev)
 	return 0;
 }
 
+/*
+ * Without this undocummented value, the returned temperatures would
+ * be higher than real ones by about 20Â°C.
+ */
+#define SUN50I_H6_CTRL0_UNK 0x0000002f
+
 static int sun50i_h6_thermal_init(struct ths_device *tmdev)
 {
 	int val;
@@ -432,7 +438,7 @@ static int sun50i_h6_thermal_init(struct ths_device *tmdev)
 	 *   = 479
 	 */
 	regmap_write(tmdev->regmap, SUN50I_THS_CTRL0,
-		     SUN50I_THS_CTRL0_T_ACQ(479));
+		     SUN50I_H6_CTRL0_UNK | SUN50I_THS_CTRL0_T_ACQ(479));
 	/* average over 4 samples */
 	regmap_write(tmdev->regmap, SUN50I_H6_THS_MFC,
 		     SUN50I_THS_FILTER_EN |
-- 
2.23.0

