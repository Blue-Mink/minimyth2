From d683137b23c770b2fb7e2ee3314e0d776617acde Mon Sep 17 00:00:00 2001
From: Qiang Yu <yuq825@gmail.com>
Date: Sun, 10 Feb 2019 10:32:50 +0800
Subject: [PATCH 04/20] drm/lima: fix job finish fence leak for 5.0

Signed-off-by: Qiang Yu <yuq825@gmail.com>
---
 drivers/gpu/drm/lima/lima_sched.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/lima/lima_sched.c b/drivers/gpu/drm/lima/lima_sched.c
index 0c6b7c3..285d6d7 100644
--- a/drivers/gpu/drm/lima/lima_sched.c
+++ b/drivers/gpu/drm/lima/lima_sched.c
@@ -120,7 +120,7 @@ int lima_sched_task_init(struct lima_sched_task *task,
 
 void lima_sched_task_fini(struct lima_sched_task *task)
 {
-	dma_fence_put(&task->base.s_fence->finished);
+	drm_sched_job_cleanup(&task->base);
 }
 
 int lima_sched_task_add_dep(struct lima_sched_task *task, struct dma_fence *fence)
@@ -400,6 +400,8 @@ static void lima_sched_free_job(struct drm_sched_job *job)
 	struct lima_sched_pipe *pipe = to_lima_pipe(job->sched);
 	int i;
 
+	drm_sched_job_cleanup(job);
+
 	dma_fence_put(task->fence);
 
 	for (i = 0; i < task->num_dep; i++) {
-- 
2.7.1

