From c839d004fec9d8e77568df970db9d6ae74dae31d Mon Sep 17 00:00:00 2001
From: Qiang Yu <yuq825@gmail.com>
Date: Mon, 11 Feb 2019 11:29:35 +0800
Subject: [PATCH 08/20] drm/lima: remove kernel gem modifier

Signed-off-by: Qiang Yu <yuq825@gmail.com>
---
 drivers/gpu/drm/lima/lima_drv.c    | 13 -------------
 drivers/gpu/drm/lima/lima_gem.c    | 32 --------------------------------
 drivers/gpu/drm/lima/lima_gem.h    |  2 --
 drivers/gpu/drm/lima/lima_object.c |  1 -
 drivers/gpu/drm/lima/lima_object.h |  2 --
 include/uapi/drm/lima_drm.h        | 11 -----------
 6 files changed, 61 deletions(-)

diff --git a/drivers/gpu/drm/lima/lima_drv.c b/drivers/gpu/drm/lima/lima_drv.c
index c5876c2..da0f4b5 100644
--- a/drivers/gpu/drm/lima/lima_drv.c
+++ b/drivers/gpu/drm/lima/lima_drv.c
@@ -175,18 +175,6 @@ static int lima_ioctl_ctx(struct drm_device *dev, void *data, struct drm_file *f
 	return -EINVAL;
 }
 
-static int lima_ioctl_gem_mod(struct drm_device *dev, void *data, struct drm_file *file)
-{
-	struct drm_lima_gem_mod *args = data;
-
-	if (args->op == LIMA_GEM_MOD_OP_GET)
-		return lima_gem_get_modifier(file, args->handle, &args->modifier);
-	else if (args->op == LIMA_GEM_MOD_OP_SET)
-		return lima_gem_set_modifier(file, args->handle, args->modifier);
-
-	return -EINVAL;
-}
-
 static int lima_drm_driver_open(struct drm_device *dev, struct drm_file *file)
 {
 	int err;
@@ -229,7 +217,6 @@ static const struct drm_ioctl_desc lima_drm_driver_ioctls[] = {
 	DRM_IOCTL_DEF_DRV(LIMA_GEM_SUBMIT, lima_ioctl_gem_submit, DRM_AUTH|DRM_RENDER_ALLOW),
 	DRM_IOCTL_DEF_DRV(LIMA_GEM_WAIT, lima_ioctl_gem_wait, DRM_AUTH|DRM_RENDER_ALLOW),
 	DRM_IOCTL_DEF_DRV(LIMA_CTX, lima_ioctl_ctx, DRM_AUTH|DRM_RENDER_ALLOW),
-	DRM_IOCTL_DEF_DRV(LIMA_GEM_MOD, lima_ioctl_gem_mod, DRM_AUTH|DRM_RENDER_ALLOW),
 };
 
 static const struct file_operations lima_drm_driver_fops = {
diff --git a/drivers/gpu/drm/lima/lima_gem.c b/drivers/gpu/drm/lima/lima_gem.c
index 9f01773..4c7262e 100644
--- a/drivers/gpu/drm/lima/lima_gem.c
+++ b/drivers/gpu/drm/lima/lima_gem.c
@@ -389,35 +389,3 @@ int lima_gem_wait(struct drm_file *file, u32 handle, u32 op, u64 timeout_ns)
 	drm_gem_object_put_unlocked(obj);
 	return ret;
 }
-
-int lima_gem_get_modifier(struct drm_file *file, u32 handle, u64 *modifier)
-{
-	struct drm_gem_object *obj;
-	struct lima_bo *bo;
-
-	obj = drm_gem_object_lookup(file, handle);
-	if (!obj)
-		return -ENOENT;
-
-	bo = to_lima_bo(obj);
-	*modifier = bo->modifier;
-
-	drm_gem_object_put_unlocked(obj);
-	return 0;
-}
-
-int lima_gem_set_modifier(struct drm_file *file, u32 handle, u64 modifier)
-{
-	struct drm_gem_object *obj;
-	struct lima_bo *bo;
-
-	obj = drm_gem_object_lookup(file, handle);
-	if (!obj)
-		return -ENOENT;
-
-	bo = to_lima_bo(obj);
-	bo->modifier = modifier;
-
-	drm_gem_object_put_unlocked(obj);
-	return 0;
-}
diff --git a/drivers/gpu/drm/lima/lima_gem.h b/drivers/gpu/drm/lima/lima_gem.h
index ed30413..ba7c6f7 100644
--- a/drivers/gpu/drm/lima/lima_gem.h
+++ b/drivers/gpu/drm/lima/lima_gem.h
@@ -17,7 +17,5 @@ int lima_gem_get_info(struct drm_file *file, u32 handle, u32 *va, u64 *offset);
 int lima_gem_mmap(struct file *filp, struct vm_area_struct *vma);
 int lima_gem_submit(struct drm_file *file, struct lima_submit *submit);
 int lima_gem_wait(struct drm_file *file, u32 handle, u32 op, u64 timeout_ns);
-int lima_gem_get_modifier(struct drm_file *file, u32 handle, u64 *modifier);
-int lima_gem_set_modifier(struct drm_file *file, u32 handle, u64 modifier);
 
 #endif
diff --git a/drivers/gpu/drm/lima/lima_object.c b/drivers/gpu/drm/lima/lima_object.c
index 34d9b4d..576b7f5 100644
--- a/drivers/gpu/drm/lima/lima_object.c
+++ b/drivers/gpu/drm/lima/lima_object.c
@@ -71,7 +71,6 @@ struct lima_bo *lima_bo_create(struct lima_device *dev, u64 size,
 	if (err)
 		goto err_out;
 
-	bo->modifier = DRM_FORMAT_MOD_INVALID;
 	return bo;
 
 err_out:
diff --git a/drivers/gpu/drm/lima/lima_object.h b/drivers/gpu/drm/lima/lima_object.h
index 54ffcc4..ec245f7 100644
--- a/drivers/gpu/drm/lima/lima_object.h
+++ b/drivers/gpu/drm/lima/lima_object.h
@@ -20,8 +20,6 @@ struct lima_bo {
 	struct ttm_bo_kmap_obj dma_buf_vmap;
 
 	struct list_head va;
-
-	u64 modifier;
 };
 
 static inline struct lima_bo *
diff --git a/include/uapi/drm/lima_drm.h b/include/uapi/drm/lima_drm.h
index 3be9eac..fbb0fda 100644
--- a/include/uapi/drm/lima_drm.h
+++ b/include/uapi/drm/lima_drm.h
@@ -105,22 +105,12 @@ struct drm_lima_ctx {
 	__u32 id;          /* in/out */
 };
 
-#define LIMA_GEM_MOD_OP_GET 0
-#define LIMA_GEM_MOD_OP_SET 1
-
-struct drm_lima_gem_mod {
-	__u32 handle;      /* in */
-	__u32 op;          /* in */
-	__u64 modifier;    /* in/out */
-};
-
 #define DRM_LIMA_INFO        0x00
 #define DRM_LIMA_GEM_CREATE  0x01
 #define DRM_LIMA_GEM_INFO    0x02
 #define DRM_LIMA_GEM_SUBMIT  0x03
 #define DRM_LIMA_GEM_WAIT    0x04
 #define DRM_LIMA_CTX         0x05
-#define DRM_LIMA_GEM_MOD     0x06
 
 #define DRM_IOCTL_LIMA_INFO DRM_IOR(DRM_COMMAND_BASE + DRM_LIMA_INFO, struct drm_lima_info)
 #define DRM_IOCTL_LIMA_GEM_CREATE DRM_IOWR(DRM_COMMAND_BASE + DRM_LIMA_GEM_CREATE, struct drm_lima_gem_create)
@@ -128,7 +118,6 @@ struct drm_lima_gem_mod {
 #define DRM_IOCTL_LIMA_GEM_SUBMIT DRM_IOWR(DRM_COMMAND_BASE + DRM_LIMA_GEM_SUBMIT, struct drm_lima_gem_submit)
 #define DRM_IOCTL_LIMA_GEM_WAIT DRM_IOW(DRM_COMMAND_BASE + DRM_LIMA_GEM_WAIT, struct drm_lima_gem_wait)
 #define DRM_IOCTL_LIMA_CTX DRM_IOWR(DRM_COMMAND_BASE + DRM_LIMA_CTX, struct drm_lima_ctx)
-#define DRM_IOCTL_LIMA_GEM_MOD DRM_IOWR(DRM_COMMAND_BASE + DRM_LIMA_GEM_MOD, struct drm_lima_gem_mod)
 
 #if defined(__cplusplus)
 }
-- 
2.7.1

