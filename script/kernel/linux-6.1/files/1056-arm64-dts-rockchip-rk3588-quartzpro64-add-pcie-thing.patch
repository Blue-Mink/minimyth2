From 0b3914a790d8cf5cdbd7245fb1624b7b13aa4cde Mon Sep 17 00:00:00 2001
From: neg2led <4232981+neg2led@users.noreply.github.com>
Date: Sun, 11 Sep 2022 00:34:39 +1000
Subject: [PATCH 56/63] arm64: dts: rockchip: rk3588-quartzpro64: add pcie
 things

---
 .../boot/dts/rockchip/rk3588-quartzpro64.dts  | 140 +++++++++++++++++-
 arch/arm64/boot/dts/rockchip/rk3588.dtsi      |   2 +-
 2 files changed, 138 insertions(+), 4 deletions(-)

diff --git a/arch/arm64/boot/dts/rockchip/rk3588-quartzpro64.dts b/arch/arm64/boot/dts/rockchip/rk3588-quartzpro64.dts
index 9beeff8ba9f..8cec3a90506 100644
--- a/arch/arm64/boot/dts/rockchip/rk3588-quartzpro64.dts
+++ b/arch/arm64/boot/dts/rockchip/rk3588-quartzpro64.dts
@@ -84,6 +84,30 @@ vcc5v0_usb_host: vcc5v0-usb-host {
 		pinctrl-0 = <&vcc5v0_usb_host_en_h>;
 	};
 
+	vcc3v3_pi6c_05: vcc3v3-pi6c-05-regulator {
+		compatible = "regulator-fixed";
+		regulator-name = "vcc3v3_pi6c_05";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		enable-active-high;
+		gpios = <&gpio3 RK_PC3 GPIO_ACTIVE_HIGH>;
+		startup-delay-us = <5000>;
+		vin-supply = <&vcc5v0_sys>;
+	};
+
+	vcc3v3_pcie30: vcc3v3-pcie30-regulator {
+		compatible = "regulator-fixed";
+		regulator-name = "vcc3v3_pcie30";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		enable-active-high;
+		pinctrl-0 = <&pcie30x4_pwren_h>;
+		pinctrl-names = "default";
+		gpios = <&gpio3 RK_PC3 GPIO_ACTIVE_HIGH>;
+		startup-delay-us = <5000>;
+		vin-supply = <&vcc12v_dcin>;
+	};
+
 	vbus5v0_typec: vbus5v0-typec {
 		compatible = "regulator-fixed";
 		regulator-name = "vbus5v0_typec";
@@ -95,6 +119,46 @@ vbus5v0_typec: vbus5v0-typec {
 		pinctrl-names = "default";
 		pinctrl-0 = <&vcc5v0_usbc_host_en_h>;
 	};
+
+	pcie20_avdd0v85: pcie20-avdd0v85 {
+		compatible = "regulator-fixed";
+		regulator-name = "pcie20_avdd0v85";
+		regulator-boot-on;
+		regulator-always-on;
+		regulator-min-microvolt = <850000>;
+		regulator-max-microvolt = <850000>;
+		vin-supply = <&avdd_0v85_s0>;
+	};
+
+	pcie20_avdd1v8: pcie20-avdd1v8 {
+		compatible = "regulator-fixed";
+		regulator-name = "pcie20_avdd1v8";
+		regulator-boot-on;
+		regulator-always-on;
+		regulator-min-microvolt = <1800000>;
+		regulator-max-microvolt = <1800000>;
+		vin-supply = <&avcc_1v8_s0>;
+	};
+
+	pcie30_avdd0v75: pcie30-avdd0v75 {
+		compatible = "regulator-fixed";
+		regulator-name = "pcie30_avdd0v75";
+		regulator-boot-on;
+		regulator-always-on;
+		regulator-min-microvolt = <750000>;
+		regulator-max-microvolt = <750000>;
+		vin-supply = <&avdd_0v75_s0>;
+	};
+
+	pcie30_avdd1v8: pcie30-avdd1v8 {
+		compatible = "regulator-fixed";
+		regulator-name = "pcie30_avdd1v8";
+		regulator-boot-on;
+		regulator-always-on;
+		regulator-min-microvolt = <1800000>;
+		regulator-max-microvolt = <1800000>;
+		vin-supply = <&avcc_1v8_s0>;
+	};
 };
 
 &cpu_l0 {
@@ -159,7 +223,8 @@ &sdhci {
 	no-sdio;
 	no-sd;
 	non-removable;
-	max-frequency = <140000000>;
+	max-frequency = <150000000>;
+	mmc-hs200-1_8v;
 	// mmc-hs400-1_8v;
 	// mmc-hs400-enhanced-strobe;
 	vmmc-supply = <&vcc_3v3_s0>;
@@ -174,12 +239,12 @@ &emmc_data_strobe
 };
 
 &sdmmc {
-	max-frequency = <140000000>;
+	max-frequency = <150000000>;
 	no-sdio;
 	no-mmc;
 	bus-width = <4>;
 	cap-sd-highspeed;
-	// sd-uhs-sdr104;
+	sd-uhs-sdr104;
 	disable-wp;
 	vmmc-supply = <&vcc_3v3_sd_s0>;
 	vqmmc-supply = <&vccio_sd_s0>;
@@ -232,6 +297,63 @@ hym8563: hym8563@51 {
 	};
 };
 
+&combphy1 {
+	// pinctrl-names = "default";
+	// pinctrl-0 = <&pcie30x1m1_pins>;
+	phy-supply = <&vcc3v3_pi6c_05>;
+	status = "okay";
+};
+
+&pcie2x1l0 {
+	reset-gpios = <&gpio4 RK_PA5 GPIO_ACTIVE_HIGH>;
+	vpcie3v3-supply = <&vcc_3v3_s0>;
+	pinctrl-0 = <&wifi_wake_host_h &wifi_pwr_en_h>;
+	pinctrl-names = "default";
+	status = "okay";
+
+	// ap6275p: wifi@0,0 {
+	// 	compatible = "brcm,bcm43455";
+	// 	reg = <0x0000 0 0 0 0>;
+	// 	pinctrl-0 = <&wifi_wake_host_h &wifi_pwr_en_h>;
+	// 	pinctrl-names = "default";
+	// 	wakeup-source;
+	// 	interrupt-parent = <&gpio3>;
+	// 	interrupts = <RK_PA7 IRQ_TYPE_LEVEL_HIGH>;
+	// 	reset-gpios = <&gpio3 RK_PB1 GPIO_ACTIVE_LOW>;
+	// };
+};
+
+&combphy2 {
+	// pinctrl-names = "default";
+	// pinctrl-0 = <&pcie30x1m1_pins>;
+	phy-supply = <&vcc3v3_pi6c_05>;
+	status = "okay";
+};
+
+&pcie2x1l1 {
+	reset-gpios = <&gpio4 RK_PA2 GPIO_ACTIVE_HIGH>;
+	pinctrl-names = "default";
+	pinctrl-0 = <&rtl8111_isolate>;
+	vpcie3v3-supply = <&vcc_3v3_s0>;
+	status = "okay";
+};
+
+&pcie30phy {
+	data-lanes = <1 1 1 1>;
+	// pinctrl-names = "default";
+	// pinctrl-0 = <&pcie30x4m1_pins>;
+	phy-supply = <&vcc3v3_pi6c_05>;
+	status = "okay";
+};
+
+&pcie3x4 {
+	/* PCIe 3.0 x4 open-ended slot */
+	num-lanes = <4>;
+	reset-gpios = <&gpio4 RK_PB6 GPIO_ACTIVE_HIGH>;
+	vpcie3v3-supply = <&vcc3v3_pcie30>;
+	status = "okay";
+};
+
 &pinctrl {
 	hym8563 {
 		hym8563_int: hym8563-int {
@@ -239,6 +361,18 @@ hym8563_int: hym8563-int {
 		};
 	};
 
+	rtl8111 {
+		rtl8111_isolate: rtl8111-isolate {
+			rockchip,pins = <1 RK_PA4 RK_FUNC_GPIO &pcfg_pull_up>;
+		};
+	};
+
+	pcie30x4 {
+		pcie30x4_pwren_h: pcie30x4-pwren-h {
+			rockchip,pins = <3 RK_PC3 RK_FUNC_GPIO &pcfg_pull_none>;
+		};
+	};
+
 	usb {
 		vcc5v0_usb_host_en_h: vcc5v0-usb-host-en-h {
 			rockchip,pins = <4 RK_PB0 RK_FUNC_GPIO &pcfg_pull_none>;
diff --git a/arch/arm64/boot/dts/rockchip/rk3588.dtsi b/arch/arm64/boot/dts/rockchip/rk3588.dtsi
index adc6864663f..9aa2c40513f 100644
--- a/arch/arm64/boot/dts/rockchip/rk3588.dtsi
+++ b/arch/arm64/boot/dts/rockchip/rk3588.dtsi
@@ -122,7 +122,7 @@ pcie3x4: pcie@fe150000 {
 		phy-names = "pcie-phy";
 		power-domains = <&power RK3588_PD_PCIE>;
 		ranges = <0x01000000 0x0 0xf0100000 0x0 0xf0100000 0x0 0x00100000>,
-			 <0x02000000 0x9 0xf0200000 0x0 0xf0200000 0x0 0x00e00000>,
+			 <0x02000000 0x0 0xf0200000 0x0 0xf0200000 0x0 0x00e00000>,
 			 <0x03000000 0x9 0x00000000 0x9 0x00000000 0x0 0x40000000>;
 		reg = <0xa 0x40000000 0x0 0x00400000>,
 		      <0x0 0xfe150000 0x0 0x00010000>,
-- 
2.36.1

