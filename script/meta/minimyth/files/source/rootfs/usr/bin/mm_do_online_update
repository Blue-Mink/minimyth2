#!/bin/sh

. /etc/rc.d/functions

if [ x${MM_MINIMYTH_ONLINE_UPDATES_URL} = "x" ] ; then
    echo "Error: No MM_MINIMYTH_ONLINE_UPDATES_URL is set. Exiting ..."
    /usr/bin/logger -t minimyth -p "local0.info" "[mm_do_online_update] Error: MM_MINIMYTH_ONLINE_UPDATES_URL is set. Exiting..."
    exit 1
fi

command=$1

pids=`/bin/pidof mm_do_online_update`
instances=`/bin/echo ${pids} | /usr/bin/wc -w`
if [ ${instances} -ne 1 ] ; then
    echo "[mm_do_online_update] Another instance already running...Exiting"
    exit 1
fi

run_rsync() {

    local src
    local dst
    local param

    src=$1
    dst=$2
    paam=$3

    echo ' '
    echo "From          : [$1]"
    echo "To            : [$2]"
    echo "Updated files :"
    /usr/bin/logger -t minimyth -p "local0.info" "[mm_do_online_update] from:[$src] to:[$dst]"

rsync \
--port 7135 \
--recursive \
--links \
--perms \
--devices \
--specials \
--checksum \
--compress \
--log-file=/var/log/online-update.log \
--out-format=' => %f' \
--log-file-format='%f [%b bytes]' \
--stats \
--exclude=/dev* \
--exclude=*.ssh* \
--exclude=*_dtb \
--exclude=*.scr \
--exclude=minimyth.conf \
--exclude=s905_autoscript \
--exclude=uEnv.ini \
$3 \
$1 \
$2 \

    echo " "

}

if [ "x${command}" = "xdoupdate" ] ; then

  echo 'Starting on-line update ...'

  rm -f /var/log/online-update.log

  run_rsync "${MM_MINIMYTH_ONLINE_UPDATES_URL}/boot/" '/media/boot' ' '
  run_rsync "${MM_MINIMYTH_ONLINE_UPDATES_URL}/root/rootfs-ro/" '/initrd/rootfs-ro' '--delete'

  is_error=`cat /var/log/online-update.log | grep -c "error"`

  if [ ${is_error} -eq 0 ] ; then

    number_upd_files=`cat /var/log/online-update.log | grep "Number of regular files transferred" | cut -d" " -f9`

    for number in ${number_upd_files} ; do

      files_total=$((${files_total} + ${number}))

    done

    echo " "
    echo "  Total updated files: ${files_total}"

    if [ x${files_total} = "x0" ] ; then

      mm_show_mythnotify 'No any files were updated ...' '' 'ok' '12' 'On-line Updates'

    else

      mm_show_mythnotify ${files_total}' files were updated !' '' 'ok' '12' 'On-line Updates'

      sync

    fi

  else

    mm_show_mythnotify 'Something went wrong :-(' '' 'error' '12' 'On-line Updates'
    echo 'Error contacting updates server !'

  fi

else

  echo 'Starting dry-run for on-line update ...'

  rm -f /var/log/online-update.log

  run_rsync "${MM_MINIMYTH_ONLINE_UPDATES_URL}/boot/" '/media/boot' '--dry-run'
  run_rsync "${MM_MINIMYTH_ONLINE_UPDATES_URL}/root/rootfs-ro/" '/initrd/rootfs-ro' '--dry-run'

  is_error=`cat /var/log/online-update.log | grep -c "error"`

  if [ ${is_error} -eq 0 ] ; then

    number_upd_files=`cat /var/log/online-update.log | grep "Number of regular files transferred" | cut -d" " -f9`

    for number in ${number_upd_files} ; do

      files_total=$((${files_total} + ${number}))

    done

    echo " "
    echo "   Total files to update: ${files_total}"

    if [ x${files_total} = "x0" ] ; then

      mm_show_mythnotify 'There is no any updates ...' '' 'ok' '12' 'On-line Updates'

    else

      mm_show_mythnotify 'There is '${files_total}' files to update !' '' 'ok' '12' 'On-line Updates'

    fi

  else

    mm_show_mythnotify 'Something went wrong :-( !' '' 'error' '12' 'On-line Updates'
    echo 'Error contacting updates server !'

  fi

fi

exit 0
