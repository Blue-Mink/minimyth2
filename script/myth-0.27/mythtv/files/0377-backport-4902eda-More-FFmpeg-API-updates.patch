From 4902eda2178c174199db8e094f04595045661f18 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Sat, 31 May 2014 01:50:44 +1000
Subject: [PATCH 16/28] More FFmpeg API updates

---
 mythplugins/mytharchive/mytharchivehelper/main.cpp |    4 ++--
 mythtv/libs/libmythtv/mhi.cpp                      |    4 ++--
 mythtv/libs/libmythtv/nuppeldecoder.cpp            |   23 +++++++++++++++-----
 mythtv/libs/libmythtv/nuppeldecoder.h              |    1 +
 4 files changed, 22 insertions(+), 10 deletions(-)

diff --git a/mythplugins/mytharchive/mytharchivehelper/main.cpp b/mythplugins/mytharchive/mytharchivehelper/main.cpp
index c7fb239..dabdc57 100644
--- a/mythplugins/mytharchive/mytharchivehelper/main.cpp
+++ b/mythplugins/mytharchive/mytharchivehelper/main.cpp
@@ -1679,7 +1679,7 @@ static int grabThumbnail(QString inFile, QString thumbList, QString outFile, int
 
     // get list of required thumbs
     QStringList list = thumbList.split(",", QString::SkipEmptyParts);
-    AVFrame *frame = avcodec_alloc_frame();
+    AVFrame *frame = av_frame_alloc();
     AVPacket pkt;
     AVPicture orig;
     AVPicture retbuf;
@@ -1795,7 +1795,7 @@ static int grabThumbnail(QString inFile, QString thumbList, QString outFile, int
         delete[] outputbuf;
 
     // free the frame
-    av_free(frame);
+    av_frame_free(&frame);
 
     // close the codec
     avcodec_close(codecCtx);
diff --git a/mythtv/libs/libmythtv/mhi.cpp b/mythtv/libs/libmythtv/mhi.cpp
index d62eaf1..4cc9ec9 100644
--- a/mythtv/libs/libmythtv/mhi.cpp
+++ b/mythtv/libs/libmythtv/mhi.cpp
@@ -1815,7 +1815,7 @@ void MHIBitmap::CreateFromMPEG(const unsigned char *data, int length)
         return;
 
     c = avcodec_alloc_context3(NULL);
-    picture = avcodec_alloc_frame();
+    picture = av_frame_alloc();
 
     if (avcodec_open2(c, codec, NULL) < 0)
         goto Close;
@@ -1887,7 +1887,7 @@ Close:
     av_free_packet(&pkt);
     avcodec_close(c);
     av_free(c);
-    av_free(picture);
+    av_frame_free(&picture);
 }
 
 // Scale the bitmap.  Only used for image derived from MPEG I-frames.
diff --git a/mythtv/libs/libmythtv/nuppeldecoder.cpp b/mythtv/libs/libmythtv/nuppeldecoder.cpp
index 7fdb972..446bb7e 100644
--- a/mythtv/libs/libmythtv/nuppeldecoder.cpp
+++ b/mythtv/libs/libmythtv/nuppeldecoder.cpp
@@ -47,7 +47,7 @@ NuppelDecoder::NuppelDecoder(MythPlayer *parent,
       disablevideo(false), totalLength(0), totalFrames(0), effdsp(0),
       directframe(NULL),            decoded_video_frame(NULL),
       mpa_vidcodec(0), mpa_vidctx(0), mpa_audcodec(0), mpa_audctx(0),
-      directrendering(false),
+      m_mpa_pic(NULL), directrendering(false),
       lastct('1'), strm_buf(0), strm(0), buf(0), buf2(0),
       videosizetotal(0), videoframesread(0), setreadahead(false)
 {
@@ -96,7 +96,8 @@ NuppelDecoder::~NuppelDecoder()
     if (strm_buf)
         delete [] strm_buf;
 
-    av_free(m_audioSamples);
+    av_freep(&m_audioSamples);
+    av_frame_free(&m_mpa_pic);
 
     while (!StoredData.empty())
     {
@@ -911,8 +912,18 @@ bool NuppelDecoder::DecodeFrame(struct rtframeheader *frameheader,
         if (!mpa_vidcodec)
             InitAVCodecVideo(frameheader->comptype - '3');
 
-        AVFrame mpa_pic;
-        avcodec_get_frame_defaults(&mpa_pic);
+        if (!m_mpa_pic)
+        {
+            if (!(m_mpa_pic = av_frame_alloc()))
+            {
+                LOG(VB_GENERAL, LOG_ERR, "DecodeFrame: Out of memory");
+                return false;
+            }
+        }
+        else
+        {
+            av_frame_unref(m_mpa_pic);
+        }
         AVPacket pkt;
         av_init_packet(&pkt);
         pkt.data = lstrm;
@@ -922,7 +933,7 @@ bool NuppelDecoder::DecodeFrame(struct rtframeheader *frameheader,
             QMutexLocker locker(avcodeclock);
             // if directrendering, writes into buf
             int gotpicture = 0;
-            int ret = avcodec_decode_video2(mpa_vidctx, &mpa_pic, &gotpicture,
+            int ret = avcodec_decode_video2(mpa_vidctx, m_mpa_pic, &gotpicture,
                                             &pkt);
             directframe = NULL;
             if (ret < 0)
@@ -964,7 +975,7 @@ bool NuppelDecoder::DecodeFrame(struct rtframeheader *frameheader,
                        video_height);
 
         myth_sws_img_convert(
-            &tmppicture, PIX_FMT_YUV420P, (AVPicture *)&mpa_pic,
+            &tmppicture, PIX_FMT_YUV420P, (AVPicture *)m_mpa_pic,
                     mpa_vidctx->pix_fmt, video_width, video_height);
     }
 
diff --git a/mythtv/libs/libmythtv/nuppeldecoder.h b/mythtv/libs/libmythtv/nuppeldecoder.h
index 896f7ea..4a4930a 100644
--- a/mythtv/libs/libmythtv/nuppeldecoder.h
+++ b/mythtv/libs/libmythtv/nuppeldecoder.h
@@ -111,6 +111,7 @@ class NuppelDecoder : public DecoderBase
     AVCodecContext *mpa_audctx;
     AVPicture tmppicture;
     uint8_t *m_audioSamples;
+    AVFrame *m_mpa_pic;
 
     bool directrendering;
 
-- 
1.7.10.2

