From 330ae8a94393c5d48fec69289d3f1abea7d57cb4 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Wed, 18 Jun 2014 17:43:37 +1000
Subject: [PATCH 01/10] Increase myth:// filetransfer timeout values.

Also reset attempts count once it successfully transfer data
---
 mythtv/libs/libmythprotoserver/sockethandler/filetransfer.cpp |    5 +++--
 mythtv/programs/mythbackend/filetransfer.cpp                  |    5 +++--
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/mythtv/libs/libmythprotoserver/sockethandler/filetransfer.cpp b/mythtv/libs/libmythprotoserver/sockethandler/filetransfer.cpp
index 68c25e3..adc8ec6 100644
--- a/mythtv/libs/libmythprotoserver/sockethandler/filetransfer.cpp
+++ b/mythtv/libs/libmythprotoserver/sockethandler/filetransfer.cpp
@@ -175,7 +175,7 @@ int FileTransfer::WriteBlock(int size)
         int request = size - tot;
         int received;
 
-        received = GetSocket()->Read(buf, (uint)request, 50 /*ms */);
+        received = GetSocket()->Read(buf, (uint)request, 200 /*ms */);
 
         if (received != request)
         {
@@ -190,7 +190,7 @@ int FileTransfer::WriteBlock(int size)
             if (received == 0)
             {
                 attempts++;
-                if (attempts >= 3)
+                if (attempts > 3)
                 {
                     LOG(VB_FILE, LOG_ERR,
                         "WriteBlock(): Read tried too many times, aborting "
@@ -200,6 +200,7 @@ int FileTransfer::WriteBlock(int size)
                 continue;
             }
         }
+        attempts = 0;
         ret = rbuffer->Write(buf, received);
         if (ret <= 0)
         {
diff --git a/mythtv/programs/mythbackend/filetransfer.cpp b/mythtv/programs/mythbackend/filetransfer.cpp
index 53d61bb..0011d18 100644
--- a/mythtv/programs/mythbackend/filetransfer.cpp
+++ b/mythtv/programs/mythbackend/filetransfer.cpp
@@ -177,7 +177,7 @@ int FileTransfer::WriteBlock(int size)
         int request = size - tot;
         int received;
 
-        received = sock->Read(buf, (uint)request, 50 /*ms */);
+        received = sock->Read(buf, (uint)request, 200 /*ms */);
 
         if (received != request)
         {
@@ -192,7 +192,7 @@ int FileTransfer::WriteBlock(int size)
             if (received == 0)
             {
                 attempts++;
-                if (attempts >= 3)
+                if (attempts > 3)
                 {
                     LOG(VB_FILE, LOG_ERR,
                         "WriteBlock(): Read tried too many times, aborting "
@@ -202,6 +202,7 @@ int FileTransfer::WriteBlock(int size)
                 continue;
             }
         }
+        attempts = 0;
         ret = rbuffer->Write(buf, received);
         if (ret <= 0)
         {
-- 
1.7.10.2

