From a86501563f987e9d4fe781b1a871b3f093e376d7 Mon Sep 17 00:00:00 2001
From: Stuart Morgan <smorgan@mythtv.org>
Date: Sat, 2 Aug 2014 22:05:47 +0100
Subject: [PATCH] UPnP: Music: Add some information derived from the mimetype
 to the fourth field of the ProtocolInfo attribute.

---
 mythtv/libs/libmythupnp/upnputil.cpp         |    1 +
 mythtv/programs/mythbackend/upnpcdsmusic.cpp |   22 +++++++++++++++++++++-
 2 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/mythtv/libs/libmythupnp/upnputil.cpp b/mythtv/libs/libmythupnp/upnputil.cpp
index 770689b..51949ff 100644
--- a/mythtv/libs/libmythupnp/upnputil.cpp
+++ b/mythtv/libs/libmythupnp/upnputil.cpp
@@ -224,3 +224,4 @@ QStringList GetSinkProtocolInfos()
 
     return protocolList;
 }
+
diff --git a/mythtv/programs/mythbackend/upnpcdsmusic.cpp b/mythtv/programs/mythbackend/upnpcdsmusic.cpp
index ff0b36f..6b92e2a 100644
--- a/mythtv/programs/mythbackend/upnpcdsmusic.cpp
+++ b/mythtv/programs/mythbackend/upnpcdsmusic.cpp
@@ -372,7 +372,27 @@ void UPnpCDSMusic::AddItem( const UPnpCDSRequest    *pRequest,
     QFileInfo fInfo( sFileName );
 
     QString sMimeType = HTTPRequest::GetMimeType( fInfo.suffix() );
-    QString sProtocol = QString( "http-get:*:%1:DLNA.ORG_OP=01;DLNA.ORG_CI=0;DLNA.ORG_FLAGS=01500000000000000000000000000000" ).arg( sMimeType  );
+
+    QString sAdditionalInfo = "*";
+    if (sMimeType == "audio/mpeg")
+    {
+        sAdditionalInfo = "DLNA.ORG_PN=MP3X";
+    }
+    else if (sMimeType == "audio/x-ms-wma")
+    {
+        sAdditionalInfo = "DLNA.ORG_PN=WMAFULL";
+    }
+    else if (sMimeType == "audio/vnd.dolby.dd-raw")
+    {
+        sAdditionalInfo = "DLNA.ORG_PN=AC3";
+    }
+    else if (sMimeType == "audio/mp4")
+    {
+        sAdditionalInfo = "DLNA.ORG_PN=AAC_ISO_320";
+    }
+
+    QString sProtocol = QString( "http-get:*:%1::%2" ).arg( sMimeType )
+                                                      .arg( sAdditionalInfo );
     QUrl    resURI    = m_URIBase;
     resURI.setPath("Content/GetMusic");
     resURI.addQueryItem("Id", QString::number(nId));
-- 
1.7.10.2

