From 6a7481bb6d3bbd5babfaf8a0a6b4390901362cac Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Mon, 30 Jun 2014 10:22:46 -0700
Subject: [PATCH 01/12] Use MythAVFrame convenience class

---
 mythplugins/mytharchive/mytharchive/thumbfinder.cpp |   18 ++++++------------
 mythplugins/mytharchive/mytharchive/thumbfinder.h   |    3 ++-
 2 files changed, 8 insertions(+), 13 deletions(-)

diff --git a/mythplugins/mytharchive/mytharchive/thumbfinder.cpp b/mythplugins/mytharchive/mytharchive/thumbfinder.cpp
index 5ddb23b..0e12344 100644
--- a/mythplugins/mytharchive/mytharchive/thumbfinder.cpp
+++ b/mythplugins/mytharchive/mytharchive/thumbfinder.cpp
@@ -88,7 +88,7 @@ ThumbFinder::ThumbFinder(MythScreenStack *parent, ArchiveItem *archiveItem,
                          const QString &menuTheme)
             :MythScreenType(parent, "ThumbFinder"),
     m_inputFC(NULL),        m_codecCtx(NULL),
-    m_codec(NULL),          m_frame(NULL),
+    m_codec(NULL),
     m_fps(0.0),             m_outputbuf(NULL),
     m_frameWidth(0),        m_frameHeight(0),
     m_videostream(0),       m_currentSeek(0),
@@ -643,8 +643,6 @@ bool ThumbFinder::initAVCodec(const QString &inFile)
     int bufflen = m_frameWidth * m_frameHeight * 4;
     m_outputbuf = new unsigned char[bufflen];
 
-    m_frame = av_frame_alloc();
-
     m_frameFile = getTempDirectory() + "work/frame.jpg";
 
     return true;
@@ -862,13 +860,13 @@ bool ThumbFinder::getFrameImage(bool needKeyFrame, int64_t requiredPTS)
     if (frameFinished)
     {
         avpicture_fill(&retbuf, m_outputbuf, PIX_FMT_RGB32, m_frameWidth, m_frameHeight);
+        AVPicture *tmp = (AVPicture*)(AVFrame*)m_frame;
 
-        avpicture_deinterlace((AVPicture*)m_frame, (AVPicture*)m_frame,
-                                m_codecCtx->pix_fmt, m_frameWidth, m_frameHeight);
+        avpicture_deinterlace(tmp, tmp, m_codecCtx->pix_fmt,
+                              m_frameWidth, m_frameHeight);
 
-        myth_sws_img_convert(
-                    &retbuf, PIX_FMT_RGB32,
-                        (AVPicture*) m_frame, m_codecCtx->pix_fmt, m_frameWidth, m_frameHeight);
+        myth_sws_img_convert(&retbuf, PIX_FMT_RGB32, tmp, m_codecCtx->pix_fmt,
+                             m_frameWidth, m_frameHeight);
 
         QImage img(m_outputbuf, m_frameWidth, m_frameHeight,
                    QImage::Format_RGB32);
@@ -899,9 +897,6 @@ void ThumbFinder::closeAVCodec()
     if (m_outputbuf)
         delete[] m_outputbuf;
 
-    // free the frame
-    av_frame_free(&m_frame);
-
     // close the codec
     if (m_codecCtx)
         avcodec_close(m_codecCtx);
@@ -1011,4 +1006,3 @@ int ThumbFinder::calcFinalDuration()
 
     return m_archiveItem->duration;
 }
-
diff --git a/mythplugins/mytharchive/mytharchive/thumbfinder.h b/mythplugins/mytharchive/mytharchive/thumbfinder.h
index d60b7a7..d8e0f01 100644
--- a/mythplugins/mytharchive/mytharchive/thumbfinder.h
+++ b/mythplugins/mytharchive/mytharchive/thumbfinder.h
@@ -16,6 +16,7 @@ extern "C" {
 // mytharchive
 #include "archiveutil.h"
 #include "remoteavformatcontext.h"
+#include "mythavutil.h"
 
 typedef struct SeekAmount
 {
@@ -79,7 +80,7 @@ class ThumbFinder : public MythScreenType
     RemoteAVFormatContext m_inputFC;
     AVCodecContext  *m_codecCtx;
     AVCodec         *m_codec;
-    AVFrame         *m_frame;
+    MythAVFrame      m_frame;
 
     float            m_fps;
     unsigned char   *m_outputbuf;
-- 
1.7.10.2

