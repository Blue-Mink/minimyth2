From 03d2e694d156af3b664f36501004f1ec5d752038 Mon Sep 17 00:00:00 2001
From: Paul Harrison <pharrison@mythtv.org>
Date: Sun, 6 Jul 2014 11:18:22 +0100
Subject: [PATCH] MusicCommon: Only connect the Exiting signal if the new view
 was created OK

Fixes Coverity ID 1213744 Use after free
---
 mythplugins/mythmusic/mythmusic/musiccommon.cpp |   30 ++++++++++++++---------
 1 file changed, 18 insertions(+), 12 deletions(-)

diff --git a/mythplugins/mythmusic/mythmusic/musiccommon.cpp b/mythplugins/mythmusic/mythmusic/musiccommon.cpp
index 6bddbc0..3d103ee 100644
--- a/mythplugins/mythmusic/mythmusic/musiccommon.cpp
+++ b/mythplugins/mythmusic/mythmusic/musiccommon.cpp
@@ -464,12 +464,13 @@ void MusicCommon::switchView(MusicView view)
             PlaylistView *view = new PlaylistView(mainStack, this);
 
             if (view->Create())
+            {
                 mainStack->AddScreen(view);
+                connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
+            }
             else
                 delete view;
 
-            connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
-
             break;
         }
 
@@ -487,12 +488,13 @@ void MusicCommon::switchView(MusicView view)
             PlaylistEditorView *view = new PlaylistEditorView(mainStack, parentScreen, "tree", restorePos);
 
             if (view->Create())
+            {
                 mainStack->AddScreen(view);
+                connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
+            }
             else
                 delete view;
 
-            connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
-
             if (oldView)
             {
                 disconnect(this , SIGNAL(Exiting()));
@@ -516,12 +518,13 @@ void MusicCommon::switchView(MusicView view)
             PlaylistEditorView *view = new PlaylistEditorView(mainStack, parentScreen, "gallery", restorePos);
 
             if (view->Create())
+            {
                 mainStack->AddScreen(view);
+                connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
+            }
             else
                 delete view;
 
-            connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
-
             if (oldView)
             {
                 disconnect(this , SIGNAL(Exiting()));
@@ -536,12 +539,13 @@ void MusicCommon::switchView(MusicView view)
             SearchView *view = new SearchView(mainStack, this);
 
             if (view->Create())
+            {
                 mainStack->AddScreen(view);
+                connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
+            }
             else
                 delete view;
 
-            connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
-
             break;
         }
 
@@ -550,12 +554,13 @@ void MusicCommon::switchView(MusicView view)
             VisualizerView *view = new VisualizerView(mainStack, this);
 
             if (view->Create())
+            {
                 mainStack->AddScreen(view);
+                connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
+            }
             else
                 delete view;
 
-            connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
-
             break;
         }
 
@@ -564,12 +569,13 @@ void MusicCommon::switchView(MusicView view)
             StreamView *view = new StreamView(mainStack, this);
 
             if (view->Create())
+            {
                 mainStack->AddScreen(view);
+                connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
+            }
             else
                 delete view;
 
-            connect(view, SIGNAL(Exiting()), this, SLOT(viewExited()));
-
             break;
         }
 
-- 
1.7.10.2

