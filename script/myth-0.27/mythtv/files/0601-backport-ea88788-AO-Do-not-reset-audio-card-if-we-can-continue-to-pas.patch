From ea887882a5a4d4cdbe397c75a1baaba1ff937aa8 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Thu, 11 Sep 2014 23:18:48 +1000
Subject: [PATCH 3/4] AO: Do not reset audio card if we can continue to
 passthrough with current configuration.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

A channel number change while doing passthrough doesnâ€™t usually require a reset of the audio card. Avoid it if we can.
This could be further extended, so we only reset the card if absolutely necessary
---
 mythtv/libs/libmyth/audio/audiooutputbase.cpp |   10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/mythtv/libs/libmyth/audio/audiooutputbase.cpp b/mythtv/libs/libmyth/audio/audiooutputbase.cpp
index 03fbb91..c8b0719 100644
--- a/mythtv/libs/libmyth/audio/audiooutputbase.cpp
+++ b/mythtv/libs/libmyth/audio/audiooutputbase.cpp
@@ -600,21 +600,27 @@ void AudioOutputBase::Reconfigure(const AudioSettings &orig_settings)
         SetupPassthrough(settings.codec, settings.codec_profile,
                          samplerate_tmp, channels_tmp);
         general_deps = samplerate == samplerate_tmp && channels == channels_tmp;
+        general_deps &= format == output_format && format == FORMAT_S16;
+    }
+    else
+    {
+        general_deps =
+            settings.format == format && lsource_channels == source_channels;
     }
 
     // Check if anything has changed
     general_deps &=
-        settings.format == format &&
         settings.samplerate  == source_samplerate &&
         settings.use_passthru == passthru &&
         lconfigured_channels == configured_channels &&
         lneeds_upmix == needs_upmix && lreenc == reenc &&
-        lsource_channels == source_channels &&
         lneeds_downmix == needs_downmix;
 
     if (general_deps && m_configure_succeeded)
     {
         VBAUDIO("Reconfigure(): No change -> exiting");
+        // if passthrough, source channels may have changed
+        source_channels = lsource_channels;
         return;
     }
 
-- 
1.7.10.2

