From 77fc3045d3f3b2c36d7259be13cfa37407d14e6b Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Wed, 10 Sep 2014 21:42:33 +1000
Subject: [PATCH 1/4] =?UTF-8?q?AVFD:=20Rescan=20audio=20stream=20when=20dete?=
 =?UTF-8?q?cting=20audio=20change=20even=20when=20passthrough.=20Also=20don=E2?=
 =?UTF-8?q?=80=99t=20drop=20the=20audio=20packet=20when=20a=20change=20occur?=
 =?UTF-8?q?s.?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 mythtv/libs/libmythtv/avformatdecoder.cpp |   26 +++++++++++++-------------
 1 file changed, 13 insertions(+), 13 deletions(-)

diff --git a/mythtv/libs/libmythtv/avformatdecoder.cpp b/mythtv/libs/libmythtv/avformatdecoder.cpp
index 33c167a..873f001 100644
--- a/mythtv/libs/libmythtv/avformatdecoder.cpp
+++ b/mythtv/libs/libmythtv/avformatdecoder.cpp
@@ -4650,6 +4650,17 @@ bool AvFormatDecoder::ProcessAudioPacket(AVStream *curstream, AVPacket *pkt,
         avcodeclock->lock();
         data_size = 0;
 
+        // Check if the number of channels or sampling rate have changed
+        if (ctx->sample_rate != audioOut.sample_rate ||
+            ctx->channels    != audioOut.channels)
+        {
+            LOG(VB_GENERAL, LOG_INFO, LOC + "Audio stream changed");
+            currentTrack[kTrackTypeAudio] = -1;
+            selectedTrack[kTrackTypeAudio].av_stream_index = -1;
+            audIdx = -1;
+            AutoSelectAudioTrack();
+        }
+
         if (audioOut.do_passthru)
         {
             if (!already_decoded)
@@ -4660,7 +4671,9 @@ bool AvFormatDecoder::ProcessAudioPacket(AVStream *curstream, AVPacket *pkt,
                     decoded_size = data_size;
                 }
                 else
+                {
                     decoded_size = -1;
+                }
             }
             memcpy(audioSamples, tmp_pkt.data, tmp_pkt.size);
             data_size = tmp_pkt.size;
@@ -4686,19 +4699,6 @@ bool AvFormatDecoder::ProcessAudioPacket(AVStream *curstream, AVPacket *pkt,
                 ret = m_audio->DecodeAudio(ctx, audioSamples, data_size, &tmp_pkt);
                 decoded_size = data_size;
             }
-
-            // When decoding some audio streams the number of
-            // channels, etc isn't known until we try decoding it.
-            if (ctx->sample_rate != audioOut.sample_rate ||
-                ctx->channels    != audioOut.channels)
-            {
-                LOG(VB_GENERAL, LOG_INFO, LOC + "Audio stream changed");
-                currentTrack[kTrackTypeAudio] = -1;
-                selectedTrack[kTrackTypeAudio].av_stream_index = -1;
-                audIdx = -1;
-                AutoSelectAudioTrack();
-                data_size = 0;
-            }
         }
         avcodeclock->unlock();
 
-- 
1.7.10.2

