From 220ee25b7a1f142b5fcb27d138e23a2f8dd37ce4 Mon Sep 17 00:00:00 2001
From: Jonatan Lindblad <jlindblad@mythtv.org>
Date: Sun, 8 Jun 2014 01:10:43 +0200
Subject: [PATCH 22/23] MythNetvision: Update thumbnail and text when
 switching search pages

Fixes #12072
---
 .../mythnetvision/mythnetvision/netsearch.cpp      |   74 +++++++++-----------
 .../mythnetvision/mythnetvision/netsearch.h        |    2 +
 2 files changed, 35 insertions(+), 41 deletions(-)

diff --git a/mythplugins/mythnetvision/mythnetvision/netsearch.cpp b/mythplugins/mythnetvision/mythnetvision/netsearch.cpp
index 4b23ddd..2376b3f 100644
--- a/mythplugins/mythnetvision/mythnetvision/netsearch.cpp
+++ b/mythplugins/mythnetvision/mythnetvision/netsearch.cpp
@@ -375,13 +375,12 @@ void NetSearch::PopulateResultList(ResultItem::resultList list)
     {
         QString title = (*i)->GetTitle();
         MythUIButtonListItem *item =
-            new MythUIButtonListItem(m_searchResultList, title);
+            new MythUIButtonListItem(m_searchResultList, title,
+                                     qVariantFromValue(*i));
         InfoMap metadataMap;
         (*i)->toMap(metadataMap);
         item->SetTextFromMap(metadataMap);
 
-        item->SetData(qVariantFromValue(*i));
-
         if (!(*i)->GetThumbnail().isEmpty())
         {
             QString dlfile = (*i)->GetThumbnail();
@@ -441,24 +440,7 @@ void NetSearch::SlotItemChanged()
 
     if (item && GetFocusWidget() == m_searchResultList)
     {
-        InfoMap metadataMap;
-        item->toMap(metadataMap);
-        SetTextFromMap(metadataMap);
-
-        if (!item->GetThumbnail().isEmpty() && m_thumbImage)
-        {
-            MythUIButtonListItem *btn = m_searchResultList->GetItemCurrent();
-            QString filename = btn->GetImageFilename();
-            if (filename.contains("%SHAREDIR%"))
-                filename.replace("%SHAREDIR%", GetShareDir());
-            m_thumbImage->Reset();
-
-            if (!filename.isEmpty())
-            {
-                m_thumbImage->SetFilename(filename);
-                m_thumbImage->Load();
-            }
-        }
+        SetTextAndThumbnail(m_searchResultList->GetItemCurrent(), item);
 
         if (m_downloadable)
         {
@@ -470,31 +452,42 @@ void NetSearch::SlotItemChanged()
     }
     else if (GetFocusWidget() == m_siteList)
     {
-        MythUIButtonListItem *item = m_siteList->GetItemCurrent();
+        MythUIButtonListItem *btn = m_siteList->GetItemCurrent();
 
-        ResultItem res(item->GetText(), QString(), QString(),
+        ResultItem res(btn->GetText(), QString(), QString(),
                        QString(), QString(), QString(), QString(),
                        QDateTime(), 0, 0, -1, QString(), QStringList(),
                        QString(), QStringList(), 0, 0, QString(),
                        0, QStringList(), 0, 0, 0);
 
-        InfoMap metadataMap;
-        res.toMap(metadataMap);
-        SetTextFromMap(metadataMap);
+        SetTextAndThumbnail(btn, &res);
+    }
+}
 
-        if (m_thumbImage)
-        {
-            QString filename = item->GetImageFilename();
-            m_thumbImage->Reset();
-            if (filename.contains("%SHAREDIR%"))
-                filename.replace("%SHAREDIR%", GetShareDir());
+void NetSearch::SetTextAndThumbnail(MythUIButtonListItem *btn, ResultItem *item)
+{
+    InfoMap metadataMap;
+    item->toMap(metadataMap);
+    SetTextFromMap(metadataMap);
 
-            if (!filename.isEmpty())
-            {
-                m_thumbImage->SetFilename(filename);
-                m_thumbImage->Load();
-            }
+    SetThumbnail(btn);
+}
+
+void NetSearch::SetThumbnail(MythUIButtonListItem *btn)
+{
+    if (m_thumbImage)
+    {
+        QString filename = btn->GetImageFilename();
+        if (filename.contains("%SHAREDIR%"))
+            filename.replace("%SHAREDIR%", GetShareDir());
+
+        if (!filename.isEmpty())
+        {
+            m_thumbImage->SetFilename(filename);
+            m_thumbImage->Load();
         }
+        else
+            m_thumbImage->Reset();
     }
 }
 
@@ -503,10 +496,6 @@ void NetSearch::customEvent(QEvent *event)
     if (event->type() == ThumbnailDLEvent::kEventType)
     {
         ThumbnailDLEvent *tde = (ThumbnailDLEvent *)event;
-
-        if (!tde)
-            return;
-
         ThumbnailData *data = tde->thumb;
 
         if (!data)
@@ -523,6 +512,9 @@ void NetSearch::customEvent(QEvent *event)
 
         if (item && item->GetText() == title)
             item->SetImage(file);
+
+        if (m_searchResultList->GetItemCurrent() == item)
+            SetThumbnail(item);
     }
     else
         NetBase::customEvent(event);
diff --git a/mythplugins/mythnetvision/mythnetvision/netsearch.h b/mythplugins/mythnetvision/mythnetvision/netsearch.h
index 0fe3918..9f47253 100644
--- a/mythplugins/mythnetvision/mythnetvision/netsearch.h
+++ b/mythplugins/mythnetvision/mythnetvision/netsearch.h
@@ -71,6 +71,8 @@ class NetSearch : public NetBase
     void LoadData(void);
     void FillGrabberButtonList(void);
     void SlotItemChanged(void);
+    void SetTextAndThumbnail(MythUIButtonListItem *btn, ResultItem *item);
+    void SetThumbnail(MythUIButtonListItem *btn);
     void customEvent(QEvent *levent);
 };
 
-- 
1.7.10.2

