From 01caefe7e3e5e43fa0d2d693c5590b19c8c8e209 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Thu, 5 Jun 2014 23:58:32 +1000
Subject: [PATCH 04/34] Update VDA and CrystalHD decoder to get_buffer2 API

---
 mythtv/libs/libmythtv/avformatdecoder.cpp          |    4 +++-
 mythtv/libs/libmythtv/privatedecoder_crystalhd.cpp |    2 +-
 mythtv/libs/libmythtv/privatedecoder_vda.cpp       |    2 +-
 3 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/mythtv/libs/libmythtv/avformatdecoder.cpp b/mythtv/libs/libmythtv/avformatdecoder.cpp
index cdba4aa..7c37e8c 100644
--- a/mythtv/libs/libmythtv/avformatdecoder.cpp
+++ b/mythtv/libs/libmythtv/avformatdecoder.cpp
@@ -3682,7 +3682,9 @@ bool AvFormatDecoder::ProcessVideoFrame(AVStream *stream, AVFrame *mpa_pic)
 
     m_parent->ReleaseNextVideoFrame(picframe, temppts);
     if (private_dec)
-        context->release_buffer(context, mpa_pic);
+    {
+        av_frame_unref(mpa_pic);
+    }
 
     decoded_video_frame = picframe;
     gotVideoFrame = 1;
diff --git a/mythtv/libs/libmythtv/privatedecoder_crystalhd.cpp b/mythtv/libs/libmythtv/privatedecoder_crystalhd.cpp
index 3a01d90..3484c61 100644
--- a/mythtv/libs/libmythtv/privatedecoder_crystalhd.cpp
+++ b/mythtv/libs/libmythtv/privatedecoder_crystalhd.cpp
@@ -525,7 +525,7 @@ int PrivateDecoderCrystalHD::GetFrame(AVStream *stream,
     if (!available)
         return result;
 
-    if (avctx->get_buffer(avctx, picture) < 0)
+    if (avctx->get_buffer2(avctx, picture, 0) < 0)
     {
         LOG(VB_GENERAL, LOG_ERR, LOC +
             QString("%1 decoded frames available but no video buffers.")
diff --git a/mythtv/libs/libmythtv/privatedecoder_vda.cpp b/mythtv/libs/libmythtv/privatedecoder_vda.cpp
index 2339c6d..e19ba74 100644
--- a/mythtv/libs/libmythtv/privatedecoder_vda.cpp
+++ b/mythtv/libs/libmythtv/privatedecoder_vda.cpp
@@ -645,7 +645,7 @@ int  PrivateDecoderVDA::GetFrame(AVStream *stream,
     VDAFrame vdaframe = m_decoded_frames.takeLast();
     m_frame_lock.unlock();
 
-    if (avctx->get_buffer(avctx, picture) < 0)
+    if (avctx->get_buffer2(avctx, picture, 0) < 0)
         return -1;
 
     picture->reordered_opaque = vdaframe.pts;
-- 
1.7.10.2

