From 5b10d387250d046bbe0c9952f7eaa167c46ebec7 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Sun, 13 Jul 2014 21:24:07 +1000
Subject: [PATCH 3/4] metadata: if video type not known, try both movie and
 television grabber
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

In case the type couldnâ€™t be identified, it would assume it was only TV

(cherry picked from commit 738a7016e657d49fa5f49f2ec46cea7fa61ff9c6)
---
 mythtv/libs/libmythmetadata/metadatadownload.cpp |   39 +++++++++++++++-------
 1 file changed, 27 insertions(+), 12 deletions(-)

diff --git a/mythtv/libs/libmythmetadata/metadatadownload.cpp b/mythtv/libs/libmythmetadata/metadatadownload.cpp
index a84d6d2..a5ee929 100644
--- a/mythtv/libs/libmythmetadata/metadatadownload.cpp
+++ b/mythtv/libs/libmythmetadata/metadatadownload.cpp
@@ -113,7 +113,7 @@ void MetadataDownload::run()
             {
                 if (lookup->GetSeason() > 0 || lookup->GetEpisode() > 0)
                     list = handleTelevision(lookup);
-                else if (!lookup->GetSubtitle().isEmpty())
+                else
                     list = handleVideoUndetermined(lookup);
 
                 if (list.isEmpty())
@@ -127,9 +127,9 @@ void MetadataDownload::run()
             }
             else
             {
-                list = handleRecordingGeneric(lookup);
+                list = handleVideoUndetermined(lookup);
                 if (lookup->GetInetref().isEmpty())
-                    list.append(handleMovie(lookup));
+                    list.append(handleRecordingGeneric(lookup));
             }
         }
         else if (lookup->GetType() == kMetadataGame)
@@ -576,19 +576,34 @@ MetadataLookupList MetadataDownload::handleTelevision(MetadataLookup *lookup)
 MetadataLookupList MetadataDownload::handleVideoUndetermined(MetadataLookup *lookup)
 {
     MetadataLookupList list;
-    MetaGrabberScript grabber =
-        MetaGrabberScript::GetGrabber(kGrabberTelevision, lookup);
 
-    if (lookup->GetInetref().isEmpty() || lookup->GetInetref() == "00000000")
+    if (lookup->GetSubtype() != kProbableMovie &&
+        !lookup->GetSubtitle().isEmpty())
+    {
+        MetaGrabberScript grabber =
+            MetaGrabberScript::GetGrabber(kGrabberTelevision, lookup);
+
+        if (lookup->GetInetref().isEmpty() || lookup->GetInetref() == "00000000")
+        {
+            list = grabber.SearchSubtitle(lookup->GetTitle(),
+                                          lookup->GetSubtitle(), lookup, false);
+        }
+        else
+        {
+            list = grabber.SearchSubtitle(lookup->GetInetref(),
+                                          lookup->GetTitle(),
+                                          lookup->GetSubtitle(), lookup, false);
+        }
+    }
+    if (lookup->GetSubtype() != kProbableMovie &&
+        (lookup->GetSeason() > 0 || lookup->GetEpisode() > 0))
     {
-        list = grabber.SearchSubtitle(lookup->GetTitle(),
-                                      lookup->GetSubtitle(), lookup, false);
+        list.append(handleTelevision(lookup));
     }
-    else
+
+    if (lookup->GetSubtype() != kProbableTelevision)
     {
-        list = grabber.SearchSubtitle(lookup->GetInetref(),
-                                      lookup->GetTitle(),
-                                      lookup->GetSubtitle(), lookup, false);
+        list.append(handleMovie(lookup));
     }
 
     if (list.count() == 1)
-- 
1.7.10.2

