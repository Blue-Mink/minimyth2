From 6be8c81d6cf50b92e170b4279d3b64fd46d61904 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Wed, 18 Jun 2014 20:18:34 +1000
Subject: [PATCH 02/10] Prevent crash opening audio settings page when invalid
 device is retrieved

---
 mythtv/libs/libmyth/audio/audiooutput.cpp          |   10 ++++++----
 .../programs/mythfrontend/audiogeneralsettings.cpp |   20 +++++++++++---------
 2 files changed, 17 insertions(+), 13 deletions(-)

diff --git a/mythtv/libs/libmyth/audio/audiooutput.cpp b/mythtv/libs/libmyth/audio/audiooutput.cpp
index 97ebae4..24543bb 100644
--- a/mythtv/libs/libmyth/audio/audiooutput.cpp
+++ b/mythtv/libs/libmyth/audio/audiooutput.cpp
@@ -276,13 +276,15 @@ void AudioOutput::ClearWarning(void)
 AudioOutput::AudioDeviceConfig* AudioOutput::GetAudioDeviceConfig(
     QString &name, QString &desc, bool willsuspendpa)
 {
-    AudioOutputSettings aosettings;
+    AudioOutputSettings aosettings(true);
     AudioOutput::AudioDeviceConfig *adc;
 
     AudioOutput *ao = OpenAudio(name, QString::null, willsuspendpa);
-    aosettings = *(ao->GetOutputSettingsCleaned());
-    delete ao;
-
+    if (ao)
+    {
+        aosettings = *(ao->GetOutputSettingsCleaned());
+        delete ao;
+    }
     if (aosettings.IsInvalid())
     {
         if (!willsuspendpa)
diff --git a/mythtv/programs/mythfrontend/audiogeneralsettings.cpp b/mythtv/programs/mythfrontend/audiogeneralsettings.cpp
index 5c20fe3..79da6d3 100755
--- a/mythtv/programs/mythfrontend/audiogeneralsettings.cpp
+++ b/mythtv/programs/mythfrontend/audiogeneralsettings.cpp
@@ -128,17 +128,19 @@ AudioConfigSettings::AudioConfigSettings(ConfigurationWizard *parent) :
     QString name = m_OutputDevice->getValue();
     AudioOutput::AudioDeviceConfig *adc =
         AudioOutput::GetAudioDeviceConfig(name, name, true);
-    if (adc->settings.IsInvalid())
+    if (adc)
     {
-        LOG(VB_GENERAL, LOG_ERR,
-            QString("Audio device %1 isn't usable Check audio configuration")
-                .arg(name));
-    }
-    audiodevs.insert(name, *adc);
-    devices.append(*adc);
-
-    delete adc;
+        if (adc->settings.IsInvalid())
+        {
+            LOG(VB_GENERAL, LOG_ERR,
+                QString("Audio device %1 isn't usable Check audio configuration")
+                    .arg(name));
+        }
+        audiodevs.insert(name, *adc);
+        devices.append(*adc);
 
+        delete adc;
+    }
     ConfigurationGroup *maingroup = new VerticalConfigurationGroup(false,
                                                                    false);
     addChild(maingroup);
-- 
1.7.10.2

