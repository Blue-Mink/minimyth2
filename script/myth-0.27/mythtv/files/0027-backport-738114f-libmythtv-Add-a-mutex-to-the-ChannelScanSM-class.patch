From 738114f03f392ed882847e29eeb1462b028a0f3c Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Tue, 6 Dec 2011 20:44:13 +0100
Subject: [PATCH 48/56] libmythtv: Add a mutex to the ChannelScanSM class

This class is accessed by two threads, the signal monitor and the
thread that drives the scan.

A segv can occur if one thread deletes the currentInfo member
while it is being used by the other.

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
Signed-off-by: Jean-Yves Avenard <jyavenard@mythtv.org>
---
 mythtv/libs/libmythtv/channelscan/channelscan_sm.cpp |    3 +++
 mythtv/libs/libmythtv/channelscan/channelscan_sm.h   |    2 ++
 2 files changed, 5 insertions(+)

diff --git a/mythtv/libs/libmythtv/channelscan/channelscan_sm.cpp b/mythtv/libs/libmythtv/channelscan/channelscan_sm.cpp
index b0227e2..cf4ab02 100644
--- a/mythtv/libs/libmythtv/channelscan/channelscan_sm.cpp
+++ b/mythtv/libs/libmythtv/channelscan/channelscan_sm.cpp
@@ -36,6 +36,7 @@ using namespace std;
 
 // Qt includes
 #include <QObject>
+#include <QMutexLocker>
 
 // MythTV includes - General
 #include "channelscan_sm.h"
@@ -745,6 +746,8 @@ void ChannelScanSM::UpdateScanTransports(const NetworkInformationTable *nit)
 
 bool ChannelScanSM::UpdateChannelInfo(bool wait_until_complete)
 {
+    QMutexLocker locker(&m_mutex);
+
     if (current == scanTransports.end())
         return true;
 
diff --git a/mythtv/libs/libmythtv/channelscan/channelscan_sm.h b/mythtv/libs/libmythtv/channelscan/channelscan_sm.h
index 27d7280..2448eab 100644
--- a/mythtv/libs/libmythtv/channelscan/channelscan_sm.h
+++ b/mythtv/libs/libmythtv/channelscan/channelscan_sm.h
@@ -37,6 +37,7 @@
 #include <QPair>
 #include <QMap>
 #include <QSet>
+#include <QMutex>
 
 // MythTV includes
 #include "frequencytables.h"
@@ -249,6 +250,7 @@ class ChannelScanSM : public MPEGStreamListener,
 
     /// Scanner thread, runs ChannelScanSM::run()
     MThread          *scannerThread;
+    QMutex           m_mutex;
 };
 
 inline void ChannelScanSM::UpdateScanPercentCompleted(void)
-- 
1.7.10.2

