From 0dd5ab38982619af18f99c4032c1010d68991047 Mon Sep 17 00:00:00 2001
From: Jim Stichnoth <jstichnoth@mythtv.org>
Date: Tue, 22 Jul 2014 06:40:49 -0700
Subject: [PATCH 2/2] Subtitles: Avoid trying to draw empty text or background
 objects.

Cherry-picked / adapted from 203db78ed2c8e9d59159d970b1eb89b5764a79f3.

Refs #12056
---
 mythtv/libs/libmythtv/subtitlescreen.cpp |   58 ++++++++++++++++--------------
 1 file changed, 32 insertions(+), 26 deletions(-)

diff --git a/mythtv/libs/libmythtv/subtitlescreen.cpp b/mythtv/libs/libmythtv/subtitlescreen.cpp
index 893724c..a3863f6 100644
--- a/mythtv/libs/libmythtv/subtitlescreen.cpp
+++ b/mythtv/libs/libmythtv/subtitlescreen.cpp
@@ -1985,38 +1985,44 @@ bool FormattedTextSubtitle::Draw(const QString &base,
             // Don't draw a background behind leading spaces.
             if (first)
                 bgrect.setLeft(bgrect.left() + x_adjust);
-            MythUIShape *bgshape =
-                parent->m_format->
-                GetBackground(parent,
-                              QString("subbg%1x%2@%3,%4")
-                              .arg(chunk_sz.width()).arg(height)
-                              .arg(x).arg(y),
-                              base, (*chunk).format);
-            bgshape->SetArea(MythRect(bgrect));
-            if (imageCache)
-                imageCache->append(bgshape);
-            if (duration > 0)
-                parent->RegisterExpiration(bgshape, start + duration);
-            result = true;
+            if (bgrect.width() > 0)
+            {
+                MythUIShape *bgshape =
+                    parent->m_format->
+                    GetBackground(parent,
+                                  QString("subbg%1x%2@%3,%4")
+                                  .arg(chunk_sz.width()).arg(height)
+                                  .arg(x).arg(y),
+                                  base, (*chunk).format);
+                bgshape->SetArea(MythRect(bgrect));
+                if (imageCache)
+                    imageCache->append(bgshape);
+                if (duration > 0)
+                    parent->RegisterExpiration(bgshape, start + duration);
+                result = true;
+            }
             // Shift to the right to account for leading spaces that
             // are removed by the MythUISimpleText constructor.  Also
             // add in padding at the end to avoid clipping.
             QRect rect(x + x_adjust, y,
                        chunk_sz.width() - x_adjust + rightPadding, height);
 
-            MythUISimpleText *text =
-                new MythUISimpleText((*chunk).text, *mythfont, rect,
-                                     Qt::AlignLeft, (MythUIType*)parent,
-                                     QString("subtxt%1x%2@%3,%4")
-                                     .arg(chunk_sz.width())
-                                     .arg(height)
-                                     .arg(x).arg(y));
-            bringToFront.append(text);
-            if (imageCache)
-                imageCache->append(text);
-            if (duration > 0)
-                parent->RegisterExpiration(text, start + duration);
-            result = true;
+            if (rect.width() > 0)
+            {
+                MythUISimpleText *text =
+                    new MythUISimpleText((*chunk).text, *mythfont, rect,
+                                         Qt::AlignLeft, (MythUIType*)parent,
+                                         QString("subtxt%1x%2@%3,%4")
+                                         .arg(chunk_sz.width())
+                                         .arg(height)
+                                         .arg(x).arg(y));
+                bringToFront.append(text);
+                if (imageCache)
+                    imageCache->append(text);
+                if (duration > 0)
+                    parent->RegisterExpiration(text, start + duration);
+                result = true;
+            }
 
             LOG(VB_VBI, LOG_INFO,
                 QString("Drawing chunk at (%1,%2): %3")
-- 
1.7.10.2

