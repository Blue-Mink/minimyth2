From 36a58a15b5a71e8213da183709da390889e784c4 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Mon, 14 Jul 2014 20:42:27 +1000
Subject: [PATCH 01/24] CoreContext: Simplify use of IsThisHost, make it work
 with hostnames

---
 mythtv/libs/libmythbase/mythcorecontext.cpp                 |   11 ++++++++++-
 mythtv/libs/libmythmetadata/metadatadownload.cpp            |    2 --
 mythtv/libs/libmythmetadata/metadataimagedownload.cpp       |    3 +--
 .../libmythprotoserver/requesthandler/fileserverhandler.cpp |    6 ++----
 mythtv/programs/mythbackend/mainserver.cpp                  |    6 ++----
 5 files changed, 15 insertions(+), 13 deletions(-)

diff --git a/mythtv/libs/libmythbase/mythcorecontext.cpp b/mythtv/libs/libmythbase/mythcorecontext.cpp
index faf9758..b986ed7 100644
--- a/mythtv/libs/libmythbase/mythcorecontext.cpp
+++ b/mythtv/libs/libmythbase/mythcorecontext.cpp
@@ -638,13 +638,22 @@ bool MythCoreContext::IsThisHost(const QString &addr)
 
 bool MythCoreContext::IsThisHost(const QString &addr, const QString &host)
 {
+    if (addr.toLower() == host.toLower())
+        return true;
+
     QHostAddress addrfix(addr);
     addrfix.setScopeId(QString());
     QString addrstr = addrfix.toString();
+
+    if (addrfix.isNull())
+    {
+        addrstr = resolveAddress(addr);
+    }
+
     QString thisip  = GetBackendServerIP4(host);
     QString thisip6 = GetBackendServerIP6(host);
 
-    return !addrfix.isNull() && ((addrstr == thisip) || (addrstr == thisip6));
+    return !addrstr.isEmpty() && ((addrstr == thisip) || (addrstr == thisip6));
 }
 
 bool MythCoreContext::IsFrontendOnly(void)
diff --git a/mythtv/libs/libmythmetadata/metadatadownload.cpp b/mythtv/libs/libmythmetadata/metadatadownload.cpp
index a5ee929..ed7e687 100644
--- a/mythtv/libs/libmythmetadata/metadatadownload.cpp
+++ b/mythtv/libs/libmythmetadata/metadatadownload.cpp
@@ -665,7 +665,6 @@ QString MetadataDownload::getMXMLPath(QString filename)
 
     if (RemoteFile::isLocal(xmlname) ||
         (xmlname.startsWith("myth://") &&
-         qurl.host().toLower() != gCoreContext->GetHostName().toLower() &&
          !gCoreContext->IsThisHost(qurl.host())))
     {
         if (RemoteFile::Exists(xmlname))
@@ -694,7 +693,6 @@ QString MetadataDownload::getNFOPath(QString filename)
 
     if (RemoteFile::isLocal(nfoname) ||
         (nfoname.startsWith("myth://") &&
-         qurl.host().toLower() != gCoreContext->GetHostName().toLower() &&
          !gCoreContext->IsThisHost(qurl.host())))
     {
         if (RemoteFile::Exists(nfoname))
diff --git a/mythtv/libs/libmythmetadata/metadataimagedownload.cpp b/mythtv/libs/libmythmetadata/metadataimagedownload.cpp
index f9b0412..9a59160 100644
--- a/mythtv/libs/libmythmetadata/metadataimagedownload.cpp
+++ b/mythtv/libs/libmythmetadata/metadataimagedownload.cpp
@@ -216,8 +216,7 @@ void MetadataImageDownload::run()
                 bool exists = false;
                 bool onMaster = false;
                 QString resolvedFN;
-                if ((lookup->GetHost().toLower() == gCoreContext->GetHostName().toLower()) ||
-                    (gCoreContext->IsThisHost(lookup->GetHost())))
+                if (gCoreContext->IsThisHost(lookup->GetHost()))
                 {
                     StorageGroup sg;
                     resolvedFN = sg.FindFile(filename);
diff --git a/mythtv/libs/libmythprotoserver/requesthandler/fileserverhandler.cpp b/mythtv/libs/libmythprotoserver/requesthandler/fileserverhandler.cpp
index 52e24e0..b75fdcb 100644
--- a/mythtv/libs/libmythprotoserver/requesthandler/fileserverhandler.cpp
+++ b/mythtv/libs/libmythprotoserver/requesthandler/fileserverhandler.cpp
@@ -828,8 +828,7 @@ bool FileServerHandler::HandleGetFileList(SocketHandler *socket,
                 "path = %3 wanthost = %4")
             .arg(groupname).arg(host).arg(path).arg(wantHost));
 
-    if ((host.toLower() == wantHost.toLower()) ||
-        gCoreContext->IsThisHost(wantHost))
+    if (gCoreContext->IsThisHost(wantHost))
     {
         StorageGroup sg(groupname, host);
         LOG(VB_FILE, LOG_INFO, "Getting local info");
@@ -895,8 +894,7 @@ bool FileServerHandler::HandleFileQuery(SocketHandler *socket,
     LOG(VB_FILE, LOG_DEBUG, QString("HandleSGFileQuery: myth://%1@%2/%3")
                              .arg(groupname).arg(wantHost).arg(filename));
 
-    if ((wantHost.toLower() == gCoreContext->GetHostName().toLower()) ||
-        gCoreContext->IsThisHost(wantHost))
+    if (gCoreContext->IsThisHost(wantHost))
     {
         // handle request locally
         LOG(VB_FILE, LOG_DEBUG, QString("Getting local info"));
diff --git a/mythtv/programs/mythbackend/mainserver.cpp b/mythtv/programs/mythbackend/mainserver.cpp
index a0b5f74..5160a13 100644
--- a/mythtv/programs/mythbackend/mainserver.cpp
+++ b/mythtv/programs/mythbackend/mainserver.cpp
@@ -7114,8 +7114,7 @@ PlaybackSock *MainServer::GetSlaveByHostname(const QString &hostname)
     {
         PlaybackSock *pbs = *iter;
         if (pbs->isSlaveBackend() &&
-            ((pbs->getHostname().toLower() == hostname.toLower()) ||
-             (gCoreContext->IsThisHost(hostname, pbs->getHostname()))))
+            gCoreContext->IsThisHost(hostname, pbs->getHostname()))
         {
             sockListLock.unlock();
             pbs->IncrRef();
@@ -7140,8 +7139,7 @@ PlaybackSock *MainServer::GetMediaServerByHostname(const QString &hostname)
     {
         PlaybackSock *pbs = *iter;
         if (pbs->isMediaServer() &&
-            ((pbs->getHostname().toLower() == hostname.toLower()) ||
-             (gCoreContext->IsThisHost(hostname, pbs->getHostname()))))
+            gCoreContext->IsThisHost(hostname, pbs->getHostname()))
         {
             pbs->IncrRef();
             return pbs;
-- 
1.7.10.2

