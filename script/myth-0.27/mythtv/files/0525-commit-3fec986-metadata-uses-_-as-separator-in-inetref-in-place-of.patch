From 3fec986ea7af959f070b31481652d0e45dbdcf62 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Tue, 15 Jul 2014 02:24:03 +1000
Subject: [PATCH] metadata: uses _ as separator in inetref in place of :
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

the inetref is used in the artwork filename, but the : character isnâ€™t permissible with all file systems (FATx, VFAT, exFAT, HFS, and AmigaOS in particular).
the : used in old inetref is kept for backward compatibility.

Attempt was made to generate a filename not using the inetref as-is, but the change was very disruptive as there are about 12 functions across various classes that generate those filenames. Likelihood of missing a case was too great.

(cherry picked from commit 6fddce08ff196a6b78b066dede0558593ba86f80)
---
 mythtv/libs/libmythmetadata/metadatagrabber.cpp    |   23 +++++++++++++++-----
 .../libs/libmythmetadata/metadataimagedownload.cpp |    2 +-
 2 files changed, 18 insertions(+), 7 deletions(-)

diff --git a/mythtv/libs/libmythmetadata/metadatagrabber.cpp b/mythtv/libs/libmythmetadata/metadatagrabber.cpp
index 5656e76..8e5f9fe 100644
--- a/mythtv/libs/libmythmetadata/metadatagrabber.cpp
+++ b/mythtv/libs/libmythmetadata/metadatagrabber.cpp
@@ -259,15 +259,24 @@ MetaGrabberScript MetaGrabberScript::FromTag(const QString &tag,
 MetaGrabberScript MetaGrabberScript::FromInetref(const QString &inetref,
                                                  bool absolute)
 {
-    static QRegExp retagref("^([a-zA-Z0-9_\\-\\.]+\\.[a-zA-Z0-9]{1,3}):(.*)");
+    static QRegExp retagref("^([a-zA-Z0-9_\\-\\.]+\\.[a-zA-Z0-9]{1,3})_(.*)");
+    static QRegExp retagref2("^([a-zA-Z0-9_\\-\\.]+\\.[a-zA-Z0-9]{1,3}):(.*)");
     static QMutex reLock;
     QMutexLocker lock(&reLock);
+    QString tag;
 
     if (retagref.indexIn(inetref) > -1)
     {
+        tag = retagref.cap(1);
+    }
+    else if (retagref2.indexIn(inetref) > -1)
+    {
+        tag = retagref2.cap(1);
+    }
+    if (!tag.isEmpty())
+    {
         // match found, pull out the grabber
-        MetaGrabberScript script = MetaGrabberScript::FromTag(retagref.cap(1),
-                                                              absolute);
+        MetaGrabberScript script = MetaGrabberScript::FromTag(tag, absolute);
         if (script.IsValid())
             return script;
     }
@@ -278,13 +287,16 @@ MetaGrabberScript MetaGrabberScript::FromInetref(const QString &inetref,
 
 QString MetaGrabberScript::CleanedInetref(const QString &inetref)
 {
-    static QRegExp retagref("^([a-zA-Z0-9_\\-\\.]+\\.[a-zA-Z0-9]{1,3}):(.*)");
+    static QRegExp retagref("^([a-zA-Z0-9_\\-\\.]+\\.[a-zA-Z0-9]{1,3})_(.*)");
+    static QRegExp retagref2("^([a-zA-Z0-9_\\-\\.]+\\.[a-zA-Z0-9]{1,3}):(.*)");
     static QMutex reLock;
     QMutexLocker lock(&reLock);
 
     // try to strip grabber tag from inetref
     if (retagref.indexIn(inetref) > -1)
         return retagref.cap(2);
+    if (retagref2.indexIn(inetref) > -1)
+        return retagref2.cap(2);
 
     return inetref;
 }
@@ -357,7 +369,6 @@ MetaGrabberScript::MetaGrabberScript(const MetaGrabberScript &other) :
 {
 }
 
-
 MetaGrabberScript& MetaGrabberScript::operator=(const MetaGrabberScript &other)
 {
     if (this != &other)
@@ -449,7 +460,7 @@ MetadataLookupList MetaGrabberScript::RunGrabber(const QStringList &args,
         while (!item.isNull())
         {
             MetadataLookup *tmp = ParseMetadataItem(item, lookup, passseas);
-            tmp->SetInetref(QString("%1:%2").arg(m_command)
+            tmp->SetInetref(QString("%1_%2").arg(m_command)
                                             .arg(tmp->GetInetref()));
             list.append(tmp);
             // MetadataLookup is to be owned by the list
diff --git a/mythtv/libs/libmythmetadata/metadataimagedownload.cpp b/mythtv/libs/libmythmetadata/metadataimagedownload.cpp
index eef4f2f..fb31810 100644
--- a/mythtv/libs/libmythmetadata/metadataimagedownload.cpp
+++ b/mythtv/libs/libmythmetadata/metadataimagedownload.cpp
@@ -403,7 +403,7 @@ QString getDownloadFilename(VideoArtworkType type, MetadataLookup *lookup,
     }
     else if (lookup->GetType() == kMetadataVideo ||
              lookup->GetType() == kMetadataRecording)
-        title = MetaGrabberScript::CleanedInetref(lookup->GetInetref());
+        title = lookup->GetInetref();
     else if (lookup->GetType() == kMetadataGame)
         title = QString("%1 (%2)").arg(lookup->GetTitle())
                     .arg(lookup->GetSystem());
-- 
1.7.10.2

