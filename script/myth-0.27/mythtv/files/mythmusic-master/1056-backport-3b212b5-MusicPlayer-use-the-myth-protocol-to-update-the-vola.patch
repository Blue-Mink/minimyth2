From 3b212b54e230da05c1880e3b88665b4b685bb34c Mon Sep 17 00:00:00 2001
From: Paul Harrison <pharrison@mythtv.org>
Date: Sat, 8 Feb 2014 23:42:07 +0000
Subject: [PATCH 2/2] MusicPlayer: use the myth protocol to update the
 volatile metadata

---
 mythplugins/mythmusic/mythmusic/musicplayer.cpp |   18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)

diff --git a/mythplugins/mythmusic/mythmusic/musicplayer.cpp b/mythplugins/mythmusic/mythmusic/musicplayer.cpp
index 3087213..b54b989 100644
--- a/mythplugins/mythmusic/mythmusic/musicplayer.cpp
+++ b/mythplugins/mythmusic/mythmusic/musicplayer.cpp
@@ -1262,16 +1262,18 @@ void MusicPlayer::updateVolatileMetadata(void)
         {
             getCurrentMetadata()->persist();
 
-            // only write the playcount & rating to the tag if it's enabled by the user
+            // only write the last played, playcount & rating to the tag if it's enabled by the user
             if (GetMythDB()->GetNumSetting("AllowTagWriting", 0) == 1)
             {
-                MetaIO *tagger = MetaIO::createTagger(getCurrentMetadata()->Filename(true));
-
-                if (tagger)
-                {
-                    tagger->writeVolatileMetadata(getCurrentMetadata()->Filename(), getCurrentMetadata());
-                    delete tagger;
-                }
+                // TODO: should move this to it's own thread
+                QStringList strList;
+                strList << QString("MUSIC_TAG_UPDATE_VOLATILE %1 %2 %3 %4 %5")
+                                   .arg(getCurrentMetadata()->Hostname())
+                                   .arg(getCurrentMetadata()->ID())
+                                   .arg(getCurrentMetadata()->Rating())
+                                   .arg(getCurrentMetadata()->Playcount())
+                                   .arg(getCurrentMetadata()->LastPlay().toString(Qt::ISODate));
+                gCoreContext->SendReceiveStringList(strList);
             }
 
             sendTrackStatsChangedEvent(getCurrentMetadata()->ID());
-- 
1.7.10

