From a450a1b8624c99a3d9b1d1b2e5be4f4207dab395 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Sun, 25 May 2014 16:26:08 +1000
Subject: [PATCH 1/8] Do not immediately save volume to DB when changing
 volume

Instead need to call SaveCurrentVolume()
---
 mythtv/libs/libmyth/audio/volumebase.cpp |   21 ++++++++++++++-------
 mythtv/libs/libmyth/audio/volumebase.h   |    1 +
 2 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/mythtv/libs/libmyth/audio/volumebase.cpp b/mythtv/libs/libmyth/audio/volumebase.cpp
index ee4783f..0727ee2 100644
--- a/mythtv/libs/libmyth/audio/volumebase.cpp
+++ b/mythtv/libs/libmyth/audio/volumebase.cpp
@@ -38,10 +38,18 @@ void VolumeBase::SetCurrentVolume(int value)
 {
     volume = max(min(value, 100), 0);
     UpdateVolume();
+}
 
+void VolumeBase::SaveCurrentVolume(void)
+{
+    if (swvol)
+    {
+        SetSWVolume(GetCurrentVolume(), true);
+        return;
+    }
     QString controlLabel = gCoreContext->GetSetting("MixerControl", "PCM");
     controlLabel += "MixerVolume";
-    gCoreContext->SaveSetting(controlLabel, volume);    
+    gCoreContext->SaveSetting(controlLabel, GetCurrentVolume());
 }
 
 void VolumeBase::AdjustCurrentVolume(int change)
@@ -92,25 +100,24 @@ MuteState VolumeBase::NextMuteState(MuteState cur)
 
 void VolumeBase::UpdateVolume(void)
 {
-    int new_volume = volume;
-    bool save = true;
+    int new_volume = GetCurrentVolume();
+
     if (current_mute_state == kMuteAll)
     {
         new_volume = 0;
-        save = false;
     }
 
     if (swvol)
     {
-        SetSWVolume(new_volume, save);
+        SetSWVolume(new_volume, false);
         return;
     }
-    
+
     for (int i = 0; i < channels; i++)
     {
         SetVolumeChannel(i, new_volume);
     }
-    
+
     // Individual channel muting is handled in GetAudioData,
     // this code demonstrates the old method.
     // if (current_mute_state == kMuteLeft)
diff --git a/mythtv/libs/libmyth/audio/volumebase.h b/mythtv/libs/libmyth/audio/volumebase.h
index 0d9a38f..73b1a34 100644
--- a/mythtv/libs/libmyth/audio/volumebase.h
+++ b/mythtv/libs/libmyth/audio/volumebase.h
@@ -20,6 +20,7 @@ class MPUBLIC VolumeBase
     bool SWVolume(void) const;
     virtual uint GetCurrentVolume(void) const;
     virtual void SetCurrentVolume(int value);
+    virtual void SaveCurrentVolume(void);
     virtual void AdjustCurrentVolume(int change);
     virtual void ToggleMute(void);
 
-- 
1.7.10.2

