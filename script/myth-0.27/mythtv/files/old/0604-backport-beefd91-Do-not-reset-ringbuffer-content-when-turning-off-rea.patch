From beefd918af9c44d09bdda13b2fef295bd7d790e2 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Fri, 11 Apr 2014 07:20:39 +0700
Subject: [PATCH 1/2] Do not reset ringbuffer content when turning off read
 internal mode.

---
 mythtv/libs/libmythtv/ringbuffer.cpp |   13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/mythtv/libs/libmythtv/ringbuffer.cpp b/mythtv/libs/libmythtv/ringbuffer.cpp
index b92921a..7a5f744 100644
--- a/mythtv/libs/libmythtv/ringbuffer.cpp
+++ b/mythtv/libs/libmythtv/ringbuffer.cpp
@@ -548,13 +548,20 @@ bool RingBuffer::SetReadInternalMode(bool mode)
     QWriteLocker lock(&rwlock);
     bool old = readInternalMode;
 
+    if (mode == old)
+    {
+        return old;
+    }
+
     readInternalMode = mode;
 
     if (!mode)
     {
-        poslock.lockForWrite();
-        readpos = 0;
-        poslock.unlock();
+        // adjust real read position in ringbuffer
+        rbrlock.lockForWrite();
+        rbrpos = (rbrpos + readOffset) % bufferSize;
+        generalWait.wakeAll();
+        rbrlock.unlock();
         // reset the read offset as we are exiting the internal read mode
         readOffset = 0;
     }
-- 
1.7.10.2

