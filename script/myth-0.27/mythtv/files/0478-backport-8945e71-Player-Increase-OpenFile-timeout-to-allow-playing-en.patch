From 8945e71ed5334f08b21f177a37c7da8c8c2f57c6 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Wed, 2 Oct 2013 18:19:38 +0100
Subject: [PATCH 26/56] Player: Increase OpenFile timeout to allow playing
 encrypted isos on a remote FE

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
Signed-off-by: Jean-Yves Avenard <jyavenard@mythtv.org>
---
 mythtv/libs/libmythtv/fileringbuffer.cpp |    9 +++++++++
 mythtv/libs/libmythtv/mythplayer.cpp     |    2 +-
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/mythtv/libs/libmythtv/fileringbuffer.cpp b/mythtv/libs/libmythtv/fileringbuffer.cpp
index b3996c8..975c433 100644
--- a/mythtv/libs/libmythtv/fileringbuffer.cpp
+++ b/mythtv/libs/libmythtv/fileringbuffer.cpp
@@ -388,6 +388,15 @@ bool FileRingBuffer::OpenFile(const QString &lfilename, uint retry_ms)
     commserror = false;
     numfailures = 0;
 
+    // The initial bitrate needs to be set with consideration for low bit rate
+    // streams (e.g. radio @ 64Kbps) such that fill_min bytes are received
+    // in a reasonable time period to enable decoders to peek the first few KB
+    // to determine type & settings.
+    QString lower = lfilename.toLower();
+    if (lower.endsWith(".img") || lower.endsWith(".iso") || lower.endsWith(".vob"))
+        rawbitrate = 3000;
+    else
+        rawbitrate = 500; // Allow for radio
     CalcReadAheadThresh();
 
     bool ok = fd2 >= 0 || remotefile;
diff --git a/mythtv/libs/libmythtv/mythplayer.cpp b/mythtv/libs/libmythtv/mythplayer.cpp
index 0fd52d5..d5646a0 100644
--- a/mythtv/libs/libmythtv/mythplayer.cpp
+++ b/mythtv/libs/libmythtv/mythplayer.cpp
@@ -929,7 +929,7 @@ int MythPlayer::OpenFile(uint retries)
     int testreadsize = 2048;
 
     MythTimer bigTimer; bigTimer.start();
-    int timeout = (retries + 1) * 500;
+    int timeout = max((retries + 1) * 500, 15000U);
     while (testreadsize <= kDecoderProbeBufferSize)
     {
         MythTimer peekTimer; peekTimer.start();
-- 
1.7.10.2

