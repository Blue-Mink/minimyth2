From 7503b4333de26c8ff53e8848a4a1f2ee8d37b928 Mon Sep 17 00:00:00 2001
From: Paul Harrison <pharrison@mythtv.org>
Date: Fri, 14 Nov 2014 20:59:30 +0000
Subject: [PATCH 2/3] MythZoneMinder: Forgot to add a couple of files in
 [7c26cd6d185]

---
 .../mythzoneminder/alarmnotifythread.cpp           |   68 ++++++++++++++++++++
 .../mythzoneminder/alarmnotifythread.h             |   32 +++++++++
 2 files changed, 100 insertions(+)
 create mode 100644 mythplugins/mythzoneminder/mythzoneminder/alarmnotifythread.cpp
 create mode 100644 mythplugins/mythzoneminder/mythzoneminder/alarmnotifythread.h

diff --git a/mythplugins/mythzoneminder/mythzoneminder/alarmnotifythread.cpp b/mythplugins/mythzoneminder/mythzoneminder/alarmnotifythread.cpp
new file mode 100644
index 0000000..6a56638
--- /dev/null
+++ b/mythplugins/mythzoneminder/mythzoneminder/alarmnotifythread.cpp
@@ -0,0 +1,68 @@
+// Qt headers
+
+// MythTV headers
+#include <mythcontext.h>
+
+// MythZoneMinder headers
+#include "alarmnotifythread.h"
+#include "zmclient.h"
+#include "zmdefines.h"
+
+class AlarmNotifyThread *AlarmNotifyThread::m_alarmNotifyThread = NULL;
+
+class AlarmNotifyThread *AlarmNotifyThread::get(void)
+{
+    if (m_alarmNotifyThread == NULL)
+        m_alarmNotifyThread = new AlarmNotifyThread;
+    return m_alarmNotifyThread;
+}
+
+AlarmNotifyThread::AlarmNotifyThread(): MThread("AlarmNotifyThread")
+{
+    m_stop = false;
+}
+
+AlarmNotifyThread::~AlarmNotifyThread()
+{
+    stop();
+}
+
+void AlarmNotifyThread::stop (void)
+{
+    if (isRunning())
+    {
+        m_stop = true;
+        wait();
+    }
+}
+
+void AlarmNotifyThread::run()
+{
+    RunProlog();
+
+    while (!m_stop)
+    {
+        // get the alarm status for all monitors
+        ZMClient::get()->updateAlarmStates();
+
+        for (int x = 0; x < ZMClient::get()->getMonitorCount(); x++)
+        {
+            Monitor *mon = ZMClient::get()->getMonitorAt(x);
+
+            if (mon->state == ALERT || mon->state == ALARM)
+            {
+                // have notifications been turned on for this monitor?
+                if (mon->showNotifications)
+                {
+                    // we can't show a popup from the AlarmNotifyThread so send
+                    // a message to ZMClient to do it for us
+                    gCoreContext->dispatch(MythEvent(QString("ZONEMINDER_NOTIFICATION %1").arg(mon->id)));
+                }
+            }
+        }
+
+        usleep(1000000);
+    }
+
+    RunEpilog();
+}
diff --git a/mythplugins/mythzoneminder/mythzoneminder/alarmnotifythread.h b/mythplugins/mythzoneminder/mythzoneminder/alarmnotifythread.h
new file mode 100644
index 0000000..b7eddea
--- /dev/null
+++ b/mythplugins/mythzoneminder/mythzoneminder/alarmnotifythread.h
@@ -0,0 +1,32 @@
+#ifndef ALARMNOTIFYTHREAD_H
+#define ALARMNOTIFYTHREAD_H
+
+// Qt headers
+
+// MythTV headers
+#include "mthread.h"
+
+// zm
+#include "zmdefines.h"
+
+class AlarmNotifyThread : public MThread
+{
+  protected:
+    AlarmNotifyThread(void);
+
+    static AlarmNotifyThread *m_alarmNotifyThread;
+
+  public:
+    ~AlarmNotifyThread(void);
+
+    static AlarmNotifyThread *get(void);
+    void stop(void);
+
+  protected:
+    void run(void);
+
+  private:
+    volatile bool m_stop;
+};
+
+#endif // ALARMNOTIFYTHREAD_H
-- 
1.7.10.2

