From 2d4be81584230ac31dd2fa4f8b602a0c5e3d82c1 Mon Sep 17 00:00:00 2001
From: Jean-Yves Avenard <jyavenard@mythtv.org>
Date: Thu, 17 Jul 2014 21:30:52 +1000
Subject: [PATCH 11/16] metadata: use extended inetref if available to
 determine the type of metadata

---
 mythtv/libs/libmythmetadata/metadatafactory.cpp |   48 +++++++++++++++++++++--
 mythtv/libs/libmythmetadata/metadatafactory.h   |    1 +
 2 files changed, 45 insertions(+), 4 deletions(-)

diff --git a/mythtv/libs/libmythmetadata/metadatafactory.cpp b/mythtv/libs/libmythmetadata/metadatafactory.cpp
index 42c9bd2..4d22a71 100644
--- a/mythtv/libs/libmythmetadata/metadatafactory.cpp
+++ b/mythtv/libs/libmythmetadata/metadatafactory.cpp
@@ -622,7 +622,10 @@ void MetadataFactory::customEvent(QEvent *levent)
 
 LookupType GuessLookupType(ProgramInfo *pginfo)
 {
-    LookupType ret = kUnknownVideo;
+    LookupType ret = GuessLookupType(pginfo->GetInetRef());
+
+    if (ret != kUnknownVideo)
+        return ret;
 
     ProgramInfo::CategoryType catType = pginfo->GetCategoryType();
     if (catType == ProgramInfo::kCategoryNone)
@@ -667,7 +670,10 @@ LookupType GuessLookupType(ProgramInfo *pginfo)
 
 LookupType GuessLookupType(MetadataLookup *lookup)
 {
-    LookupType ret = kUnknownVideo;
+    LookupType ret = GuessLookupType(lookup->GetInetref());
+
+    if (ret != kUnknownVideo)
+        return ret;
 
     if (lookup->GetSeason() > 0 || lookup->GetEpisode() > 0 ||
         !lookup->GetSubtitle().isEmpty())
@@ -680,7 +686,10 @@ LookupType GuessLookupType(MetadataLookup *lookup)
 
 LookupType GuessLookupType(VideoMetadata *metadata)
 {
-    LookupType ret = kUnknownVideo;
+    LookupType ret = GuessLookupType(metadata->GetInetRef());
+
+    if (ret != kUnknownVideo)
+        return ret;
 
     if (metadata->GetSeason() > 0 || metadata->GetEpisode() > 0 ||
         !metadata->GetSubtitle().isEmpty())
@@ -693,7 +702,10 @@ LookupType GuessLookupType(VideoMetadata *metadata)
 
 LookupType GuessLookupType(RecordingRule *recrule)
 {
-    LookupType ret = kUnknownVideo;
+    LookupType ret = GuessLookupType(recrule->m_inetref);
+
+    if (ret != kUnknownVideo)
+        return ret;
 
     if (recrule->m_season > 0 || recrule->m_episode > 0 ||
         !recrule->m_subtitle.isEmpty())
@@ -704,3 +716,31 @@ LookupType GuessLookupType(RecordingRule *recrule)
     return ret;
 }
 
+LookupType GuessLookupType(const QString &inetref)
+{
+    if (inetref.isEmpty() || inetref == "00000000" ||
+        inetref == MetaGrabberScript::CleanedInetref(inetref))
+    {
+        // can't determine subtype from inetref
+        return kUnknownVideo;
+    }
+
+    // inetref is defined, see if we have a pre-defined grabber
+    MetaGrabberScript grabber =
+        MetaGrabberScript::FromInetref(inetref);
+
+    if (!grabber.IsValid())
+    {
+        return kUnknownVideo;
+    }
+
+    switch (grabber.GetType())
+    {
+        case kGrabberMovie:
+            return kProbableMovie;
+        case kGrabberTelevision:
+            return kProbableTelevision;
+        default:
+            return kUnknownVideo;
+    }
+}
diff --git a/mythtv/libs/libmythmetadata/metadatafactory.h b/mythtv/libs/libmythmetadata/metadatafactory.h
index 4b80431..ec13335 100644
--- a/mythtv/libs/libmythmetadata/metadatafactory.h
+++ b/mythtv/libs/libmythmetadata/metadatafactory.h
@@ -154,5 +154,6 @@ META_PUBLIC LookupType GuessLookupType(ProgramInfo *pginfo);
 META_PUBLIC LookupType GuessLookupType(MetadataLookup *lookup);
 META_PUBLIC LookupType GuessLookupType(VideoMetadata *metadata);
 META_PUBLIC LookupType GuessLookupType(RecordingRule *recrule);
+META_PUBLIC LookupType GuessLookupType(const QString& inetref);
 
 #endif
-- 
1.7.10.2

