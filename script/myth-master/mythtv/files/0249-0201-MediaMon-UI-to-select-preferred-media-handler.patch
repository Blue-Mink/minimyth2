From b180a72ec36a546c6dc5781827ab786f1568e674 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Thu, 16 Jan 2014 19:04:59 +0000
Subject: [PATCH 201/333] MediaMon: UI to select preferred media handler

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythplugins/mythgallery/mythgallery/main.cpp |   21 ++++++++++--------
 mythplugins/mythmusic/mythmusic/main.cpp     |   14 ++++++------
 mythtv/libs/libmyth/mythmediamonitor.cpp     |   30 +++++++++++++++++++++++---
 mythtv/programs/mythfrontend/main.cpp        |    7 +++---
 4 files changed, 51 insertions(+), 21 deletions(-)

diff --git a/mythplugins/mythmusic/mythmusic/main.cpp b/mythplugins/mythmusic/mythmusic/main.cpp
index e0e6c79..e1c0e04 100644
--- a/mythplugins/mythmusic/mythmusic/main.cpp
+++ b/mythplugins/mythmusic/mythmusic/main.cpp
@@ -874,9 +874,10 @@ static void setupKeys(void)
     REG_KEY("Music", "SWITCHTORADIO",                 QT_TRANSLATE_NOOP("MythControls",
         "Switch to the radio stream view"), "");
 
-    REG_MEDIA_HANDLER(QT_TRANSLATE_NOOP("MythControls",
-        "MythMusic Media Handler 1/2"), "", "", handleCDMedia,
-        MEDIATYPE_AUDIO | MEDIATYPE_MIXED, QString::null);
+    REG_MEDIA_HANDLER(
+        QT_TRANSLATE_NOOP("MythControls", "MythMusic Media Handler 1/2"),
+        QT_TRANSLATE_NOOP("MythControls", "MythMusic audio CD"),
+        "", handleCDMedia, MEDIATYPE_AUDIO | MEDIATYPE_MIXED, QString::null);
     QString filt;
     Q_FOREACH(QString format, GetMusicFilter())
     {
@@ -886,9 +887,10 @@ static void setupKeys(void)
         else
             filt += "," + format;
     }
-    REG_MEDIA_HANDLER(QT_TRANSLATE_NOOP("MythControls",
-        "MythMusic Media Handler 2/2"), "", "", handleMedia,
-        MEDIATYPE_MMUSIC, filt);
+    REG_MEDIA_HANDLER(
+        QT_TRANSLATE_NOOP("MythControls", "MythMusic Media Handler 2/2"),
+        QT_TRANSLATE_NOOP("MythControls", "MythMusic audio files"),
+         "", handleMedia, MEDIATYPE_MMUSIC, filt);
 }
 
 int mythplugin_init(const char *libversion)
diff --git a/mythtv/libs/libmyth/mythmediamonitor.cpp b/mythtv/libs/libmyth/mythmediamonitor.cpp
index 25a1b30..3e3d37b 100644
--- a/mythtv/libs/libmyth/mythmediamonitor.cpp
+++ b/mythtv/libs/libmyth/mythmediamonitor.cpp
@@ -669,15 +669,39 @@ void MediaMonitor::JumpToMediaHandler(MythMediaDevice* pMedia)
         return;
     }
 
-
-    // TODO - Generate a dialog, add buttons for each description,
-    // if user didn't cancel, selected = handlers.at(choice);
     int selected = 0;
+    if (handlers.size() > 1)
+    {
+        QStringList buttonmsgs;
+        for (QList<MHData>::const_iterator it = handlers.begin(); it != handlers.end(); ++it)
+            buttonmsgs << ((!it->description.isEmpty()) ? it->description : it->destination);
+        buttonmsgs << tr("Cancel");
+
+        const DialogCode cancelbtn = DialogCode(
+            int(kDialogCodeButton0) + buttonmsgs.size() - 1);
+
+        DialogCode ret = MythPopupBox::ShowButtonPopup(GetMythMainWindow(),
+                                tr("Media Handler Selection"),
+                                tr("The new media contains mixed content "
+                                   "that can be rendered in different ways. "
+                                   "Select your preferred method."),
+                                buttonmsgs, cancelbtn);
+        if (kDialogCodeRejected == ret || cancelbtn == ret)
+        {
+            LOG(VB_MEDIA, LOG_INFO, "User cancelled media handler selection");
+            return;
+        }
+
+        selected = MythDialog::CalcItemIndex(ret);
+        LOG(VB_MEDIA, LOG_NOTICE, QString("User selected '%1'")
+            .arg(handlers.at(selected).destination) );
+    }
 
     GetMythMainWindow()->JumpTo("Main Menu");
     QTime t; t.start();
     while (GetMythMainWindow()->IsExitingToMain() && t.elapsed() < 2000)
         qApp->processEvents(); // Ensure jump is executed before calling handler
+
     handlers.at(selected).callback(pMedia);
 }
 

-- 
1.7.9.5

